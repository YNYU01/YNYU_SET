# YNYUAET 项目大纲与技术分析

## 一、项目概述

YNYUAET项目围绕设计性文件的三个难以兼容的特性（排版、图片、组件），引入**动态、链式触发渲染、最大可编辑性**的概念，建立一种新的综合体格式`.zy`。

### 核心设计理念
- **动态生成**：通过节点编辑器脱离设计软件进行动态生成
- **链式触发渲染**：节点间的数据流和依赖关系
- **最大可编辑性**：母版可在设计软件中进一步编辑，同时保持与节点数据的关联

---

## 二、.zy 格式规范

### 2.1 格式结构（参考 Sketch 格式）

`.zy` 文件是一个压缩包，包含以下内容：

```text
.zy
├── node_data.json          # 节点数据（可在节点编辑器解析）
├── master_template.zyxml   # 母版文件（混合XML/JSON或超级压缩格式）
├── snapshot.png            # 快照图片（母版预览图）
├── assets/                 # 外链图片文件夹
│   ├── image1.png
│   └── image2.jpg
└── templates/              # 模板素材文件夹（内嵌脚本和变量的SVG）
    ├── complex_element1.svg
    └── complex_element2.svg
```

### 2.2 各文件说明

#### 1. 节点数据 (node_data.json)
- **用途**：可在节点编辑器解析的节点数据，用于动态生成
- **功能**：
  - 脱离设计软件进行动态生成的相关数据管理
  - 通过节点编辑器得到母版
  - 传入不同尺寸和素材得到不同变体
  - 变体数据可在母版导入设计软件后基于对应图层延展变体

#### 2. 母版文件 (master_template.zyxml)
- **格式**：混合XML和JSON格式，或超级压缩格式
- **用途**：记录母版，只能由设计软件解析成支持的图层
- **特点**：导入设计软件后可进一步设计

#### 3. 快照图片 (snapshot.png)
- **用途**：母版的预览图
- **功能**：母版作为模板时方便挑选

#### 4. 外链图片文件夹 (assets/)
- **用途**：存放用户在节点编辑时上传的图片
- **功能**：
  - 导入节点数据和母版后重新编码到元素或图层
  - 直接保持文件名替换这些素材也可以得到母版的变体

#### 5. 模板素材文件夹 (templates/)
- **用途**：存放内嵌了脚本和变量的SVG素材
- **特点**：
  - 常用于复杂设计元素
  - 利用SVG的原生兼容性在浏览器复现复杂的设计效果
  - 部分设计软件可解析为组件
  - 配合母版实现更强大的模板
  - 关键参数需要先从节点数据里获取或保持默认

---

## 三、项目模块分析

### 3.1 节点编辑器 (ListEase)

**路径**：`tool_web/ListEase/`

#### 功能定位
- 可视化节点编辑器
- 支持节点间的连接和数据流
- 动态生成设计变体

#### 当前进度
✅ **已完成**：
- 基础节点编辑器框架（`ZY_NODE` 类）
- 节点类型系统（合成预览、图片、LOGO、文本等）
- 节点连接系统（输入/输出端口）
- 视图缩放和导航
- 模板选择系统（10种预设模板）
- 右键菜单和快捷操作
- 数据导入/导出基础功能

⚠️ **部分完成**：
- 节点数据到母版的转换逻辑
- 变体数据的生成和管理
- .zy格式的完整导出

❌ **未完成**：
- 链式触发渲染引擎
- 节点数据与母版的双向同步
- 复杂节点的参数化配置
- 节点预览的实时渲染

#### 技术难点

1. **链式触发渲染机制**
   - **难点**：实现节点间的依赖关系计算和自动触发
   - **挑战**：
     - 循环依赖检测
     - 性能优化（避免不必要的重渲染）
     - 异步节点的处理
   - **解决方案**：
     - 使用有向无环图（DAG）管理依赖
     - 实现增量更新机制
     - 引入虚拟节点和懒加载

2. **节点数据到母版的转换**
   - **难点**：将抽象的节点数据转换为具体的设计图层
   - **挑战**：
     - 保持图层的可编辑性
     - 处理不同设计软件的兼容性
     - 支持复杂的布局规则
   - **解决方案**：
     - 定义中间层抽象（图层描述符）
     - 实现多目标编译器（Figma/PS/AI等）

3. **变体数据管理**
   - **难点**：管理多个变体的数据和关联关系
   - **挑战**：
     - 变体间的差异追踪
     - 母版更新后变体的同步
     - 变体数据的版本控制
   - **解决方案**：
     - 使用差异算法（diff）记录变化
     - 实现变体继承机制
     - 引入版本管理系统

---

### 3.2 效果编辑器 (VFontX)

**路径**：`tool_web/VFontX/`

#### 功能定位
- 字体效果编辑器
- 支持本地字体加载
- 实时预览字体效果

#### 当前进度
✅ **已完成**：
- 基础UI框架
- 本地字体文件夹读取（File System Access API）
- 字体选择器
- Canvas渲染区域

⚠️ **部分完成**：
- 字体效果编辑功能
- 效果参数化配置

❌ **未完成**：
- 与节点编辑器的集成
- 效果导出为节点数据
- 复杂字体效果的实现

#### 技术难点

1. **字体效果渲染**
   - **难点**：在Canvas中实现复杂的字体效果
   - **挑战**：
     - 性能优化（大量文字渲染）
     - 效果的可编辑性
     - 跨浏览器兼容性
   - **解决方案**：
     - 使用WebGL加速渲染
     - 实现效果栈系统
     - 提供降级方案

2. **本地字体管理**
   - **难点**：管理大量本地字体文件
   - **挑战**：
     - 字体文件的索引和缓存
     - 字体信息的提取（字重、样式等）
     - 权限管理
   - **解决方案**：
     - 使用IndexedDB缓存字体信息
     - 使用opentype.js解析字体
     - 实现字体预览系统

---

### 3.3 Figma插件 (ToolsSetFig)

**路径**：`tool_plugin/ToolsSetFig/`

#### 功能定位
- Figma插件，支持.zy格式的导入导出
- 批量创建和编辑功能
- 与节点编辑器的数据互通

#### 当前进度
✅ **已完成**：
- 插件基础框架（webpack构建）
- 创建页：支持图片、表格、.zy文件导入
- 导出页：支持Image、.zy、Rich Text导出
- .zy格式的基础导入导出（`exportZyInfo`函数）
- Markdown到节点的转换（`createZy`）
- 表格驱动内容生成
- 变量和样式管理
- 编辑页基础功能

⚠️ **部分完成**：
- .zy格式的完整规范实现
- 母版文件的生成和解析
- 嵌套组件的支持

❌ **未完成**：
- 完整的.zy压缩包生成
- 快照图片的自动生成
- 模板素材文件夹的处理
- 节点数据与Figma图层的双向同步

#### 技术难点

1. **.zy格式的完整实现**
   - **难点**：实现完整的.zy格式规范
   - **挑战**：
     - 压缩包的结构管理
     - 多文件格式的协调
     - 版本兼容性
   - **解决方案**：
     - 使用JSZip生成压缩包
     - 定义格式版本号
     - 实现格式验证和迁移

2. **母版文件的生成**
   - **难点**：将Figma图层转换为.zyxml格式
   - **挑战**：
     - 保持图层的完整信息
     - 支持复杂图层结构
     - 文件大小优化
   - **解决方案**：
     - 使用混合XML/JSON格式
     - 实现超级压缩算法
     - 支持增量更新

3. **节点数据与图层的映射**
   - **难点**：建立节点数据与Figma图层的对应关系
   - **挑战**：
     - 图层命名规范
     - 变体数据的应用
     - 双向同步机制
   - **解决方案**：
     - 使用图层ID和命名约定
     - 实现差异算法
     - 提供手动映射工具

4. **SVG模板的解析**
   - **难点**：解析内嵌脚本和变量的SVG
   - **挑战**：
     - SVG中的JavaScript执行
     - 变量替换机制
     - 安全性考虑
   - **解决方案**：
     - 使用沙箱环境执行脚本
     - 定义变量替换规范
     - 实现模板验证系统

---

## 四、核心技术栈

### 4.1 前端技术
- **基础**：HTML5, CSS3, JavaScript (ES6+)
- **构建工具**：Webpack (Figma插件)
- **字体处理**：opentype.js
- **图像处理**：Canvas API, WebGL
- **文件处理**：JSZip, File System Access API

### 4.2 设计软件集成
- **Figma Plugin API**
- **Adobe插件开发**（ToolsSetPs, ToolsSetMg - 规划中）

### 4.3 数据格式
- **JSON**：节点数据
- **XML/JSON混合**：母版文件
- **SVG**：模板素材
- **ZIP**：.zy压缩包

---

## 五、项目进度总览

### 5.1 整体进度：约 40%

| 模块 | 进度 | 状态 |
|------|------|------|
| 节点编辑器 (ListEase) | 50% | 🟡 进行中 |
| 效果编辑器 (VFontX) | 30% | 🟡 进行中 |
| Figma插件 (ToolsSetFig) | 60% | 🟡 进行中 |
| .zy格式规范 | 40% | 🟡 进行中 |
| 文档和测试 | 20% | 🔴 待开始 |

### 5.2 关键里程碑

#### ✅ 已完成
- [x] 节点编辑器基础框架
- [x] Figma插件基础功能
- [x] .zy格式的基础导入导出
- [x] 模板系统基础实现

#### 🟡 进行中
- [ ] 链式触发渲染引擎
- [ ] 完整的.zy格式实现
- [ ] 节点数据与母版的双向同步
- [ ] 效果编辑器的完整功能

#### 🔴 待开始
- [ ] 完整的文档系统
- [ ] 单元测试和集成测试
- [ ] 性能优化
- [ ] 多设计软件支持（PS, AI等）

---

## 六、技术难点汇总

### 6.1 架构层面

1. **数据流管理**
   - 节点数据 → 母版 → 变体的数据流
   - 双向同步机制
   - 版本控制和冲突解决

2. **跨平台兼容**
   - 不同设计软件的API差异
   - 格式转换的准确性
   - 功能降级策略

3. **性能优化**
   - 大量节点的渲染性能
   - 复杂图层的处理速度
   - 文件大小的控制

### 6.2 实现层面

1. **链式触发渲染**
   - 依赖图构建
   - 增量更新
   - 异步处理

2. **格式转换**
   - 节点数据到图层的转换
   - 图层到节点数据的反向转换
   - 格式版本迁移

3. **模板系统**
   - SVG脚本执行
   - 变量替换
   - 模板缓存

### 6.3 工程层面

1. **构建系统**
   - 多目标构建（Web/Figma/PS等）
   - 代码复用
   - 依赖管理

2. **测试**
   - 单元测试框架
   - 集成测试
   - 格式兼容性测试

3. **文档**
   - API文档
   - 用户手册
   - 格式规范文档

---

## 七、下一步计划

### 7.1 短期目标（1-3个月）

1. **完善.zy格式实现**
   - 实现完整的压缩包生成
   - 完善母版文件格式
   - 添加格式验证

2. **优化节点编辑器**
   - 实现链式触发渲染
   - 完善节点类型系统
   - 添加实时预览

3. **增强Figma插件**
   - 完善.zy导入导出
   - 实现快照生成
   - 添加模板素材支持

### 7.2 中期目标（3-6个月）

1. **双向同步机制**
   - 节点数据 ↔ 母版同步
   - 变体管理
   - 冲突解决

2. **效果编辑器完善**
   - 完整的效果系统
   - 与节点编辑器集成
   - 效果导出

3. **性能优化**
   - 渲染性能优化
   - 文件大小优化
   - 加载速度优化

### 7.3 长期目标（6-12个月）

1. **多平台支持**
   - Adobe插件开发
   - 其他设计软件支持

2. **生态系统**
   - 模板市场
   - 插件系统
   - 社区支持

3. **企业级功能**
   - 协作功能
   - 版本控制
   - 权限管理

---

## 八、风险评估

### 8.1 技术风险

| 风险 | 影响 | 概率 | 应对措施 |
|------|------|------|----------|
| 格式兼容性问题 | 高 | 中 | 建立格式测试套件，版本迁移机制 |
| 性能瓶颈 | 中 | 高 | 性能监控，渐进式优化 |
| 跨平台差异 | 高 | 中 | 抽象层设计，降级策略 |

### 8.2 项目风险

| 风险 | 影响 | 概率 | 应对措施 |
|------|------|------|----------|
| 开发进度延迟 | 中 | 中 | 优先级管理，里程碑检查 |
| 需求变更 | 中 | 低 | 灵活架构，模块化设计 |
| 资源不足 | 低 | 低 | 开源协作，社区支持 |

---

## 九、参考资料

### 9.1 相关项目
- Sketch文件格式
- Figma Plugin API
- Adobe插件开发文档

### 9.2 技术文档
- 项目README：`README.md`
- Figma插件发布说明：`tool_plugin/ToolsSetFig/README_RELEASE.md`
- Demo项目：`C:/Users/Administrator/Desktop/listEase`

---

## 十、总结

YNYUAET项目是一个创新的设计文件格式和工具链项目，旨在解决设计文件的兼容性和可编辑性问题。目前项目已完成了基础框架的搭建，核心功能正在逐步完善中。

**关键成就**：
- ✅ 建立了.zy格式的基础规范
- ✅ 实现了节点编辑器的基础功能
- ✅ 完成了Figma插件的基础集成

**主要挑战**：
- 🔴 链式触发渲染机制的实现
- 🔴 完整的.zy格式规范实现
- 🔴 跨平台兼容性

**下一步重点**：
1. 完善.zy格式的完整实现
2. 实现链式触发渲染引擎
3. 建立节点数据与母版的双向同步机制

---

*文档生成时间：2025.12.3*
*项目版本：1.0.0*

