<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  <title>FlowView - Connection Manager</title>
  <style>
    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, sans-serif;
      padding: 16px;
      margin: 0;
      background: #f5f5f5;
    }
    .container {
      background: white;
      border-radius: 8px;
      padding: 16px;
      box-shadow: 0 2px 8px rgba(0,0,0,0.1);
    }
    h2 {
      margin: 0 0 16px 0;
      font-size: 18px;
      font-weight: 600;
      color: #333;
    }
    .section {
      margin-bottom: 24px;
    }
    .section-title {
      font-size: 14px;
      font-weight: 600;
      color: #666;
      margin-bottom: 8px;
    }
    select, input {
      width: 100%;
      padding: 8px;
      border: 1px solid #ddd;
      border-radius: 4px;
      font-size: 14px;
      box-sizing: border-box;
    }
    select {
      margin-bottom: 8px;
    }
    button {
      width: 100%;
      padding: 10px;
      background: #4A90E2;
      color: white;
      border: none;
      border-radius: 4px;
      font-size: 14px;
      font-weight: 500;
      cursor: pointer;
      margin-top: 8px;
    }
    button:hover {
      background: #357ABD;
    }
    button:disabled {
      background: #ccc;
      cursor: not-allowed;
    }
    button.danger {
      background: #E74C3C;
    }
    button.danger:hover {
      background: #C0392B;
    }
    .connection-list {
      max-height: 200px;
      overflow-y: auto;
      border: 1px solid #ddd;
      border-radius: 4px;
      padding: 8px;
      background: #fafafa;
    }
    .connection-item {
      padding: 8px;
      margin-bottom: 4px;
      background: white;
      border-radius: 4px;
      font-size: 12px;
      display: flex;
      justify-content: space-between;
      align-items: center;
    }
    .connection-item:last-child {
      margin-bottom: 0;
    }
    .connection-info {
      flex: 1;
    }
    .disconnect-btn {
      width: auto;
      padding: 4px 8px;
      margin: 0;
      font-size: 11px;
    }
  </style>
</head>
<body>
  <div class="container">
    <h2>FlowView Connection Manager</h2>
    
    <!-- 连接节点 -->
    <div class="section">
      <div class="section-title">Connect Nodes</div>
      <select id="fromNodeSelect">
        <option value="">Select source node...</option>
      </select>
      <select id="fromDirectionSelect">
        <option value="top">Top</option>
        <option value="right">Right</option>
        <option value="bottom">Bottom</option>
        <option value="left">Left</option>
      </select>
      <select id="toNodeSelect">
        <option value="">Select target node...</option>
      </select>
      <select id="toDirectionSelect">
        <option value="top">Top</option>
        <option value="right">Right</option>
        <option value="bottom">Bottom</option>
        <option value="left">Left</option>
      </select>
      <button id="connectButton">Connect</button>
    </div>
    
    <!-- 断开连接 -->
    <div class="section">
      <div class="section-title">Disconnect</div>
      <div class="connection-list" id="connectionList">
        <div style="padding: 16px; text-align: center; color: #999;">
          No connections yet
        </div>
      </div>
    </div>
  </div>

  <script>
    let nodes = [];
    let connections = [];

    // 获取节点列表 - 由于每个widget是独立的，无法直接获取所有节点
    // 这个方法暂时不使用，改为等待widget主动发送节点信息
    function refreshNodes() {
      // 不发送消息，等待widget主动发送节点信息
      // parent.postMessage({ pluginMessage: { type: "getNodes" } }, "*");
    }

    // 更新节点选择器
    function updateNodeSelects() {
      const fromSelect = document.getElementById("fromNodeSelect");
      const toSelect = document.getElementById("toNodeSelect");
      
      // 清空选项
      fromSelect.innerHTML = '<option value="">Select source node...</option>';
      toSelect.innerHTML = '<option value="">Select target node...</option>';
      
      // 添加节点选项
      nodes.forEach(node => {
        const option1 = document.createElement("option");
        option1.value = node.id;
        option1.textContent = node.label || node.id;
        fromSelect.appendChild(option1);
        
        const option2 = document.createElement("option");
        option2.value = node.id;
        option2.textContent = node.label || node.id;
        toSelect.appendChild(option2);
      });
    }

    // 更新连接列表
    function updateConnectionList() {
      const connectionList = document.getElementById("connectionList");
      
      if (connections.length === 0) {
        connectionList.innerHTML = '<div style="padding: 16px; text-align: center; color: #999;">No connections yet</div>';
        return;
      }
      
      connectionList.innerHTML = connections.map(conn => {
        const fromNode = nodes.find(n => n.id === conn.fromNodeId);
        const toNode = nodes.find(n => n.id === conn.toNodeId);
        const fromLabel = fromNode ? (fromNode.label || fromNode.id) : conn.fromNodeId;
        const toLabel = toNode ? (toNode.label || toNode.id) : conn.toNodeId;
        
        return `
          <div class="connection-item">
            <div class="connection-info">
              ${fromLabel} (${conn.fromDirection}) → ${toLabel} (${conn.toDirection})
            </div>
            <button class="disconnect-btn danger" data-conn-id="${conn.id}" data-node-id="${fromNode ? fromNode.id : ''}">
              Disconnect
            </button>
          </div>
        `;
      }).join('');
      
      // 绑定断开连接按钮
      connectionList.querySelectorAll('.disconnect-btn').forEach(btn => {
        btn.onclick = () => {
          const connId = btn.getAttribute('data-conn-id');
          const nodeId = btn.getAttribute('data-node-id');
          parent.postMessage({
            pluginMessage: {
              type: "disconnectNode",
              data: { nodeId, connectionId: connId }
            }
          }, "*");
        };
      });
    }

    // 连接按钮
    document.getElementById("connectButton").onclick = () => {
      const fromNodeId = document.getElementById("fromNodeSelect").value;
      const fromDirection = document.getElementById("fromDirectionSelect").value;
      const toNodeId = document.getElementById("toNodeSelect").value;
      const toDirection = document.getElementById("toDirectionSelect").value;
      
      if (!fromNodeId || !toNodeId) {
        alert("Please select both source and target nodes");
        return;
      }
      
      if (fromNodeId === toNodeId) {
        alert("Cannot connect a node to itself");
        return;
      }
      
      parent.postMessage({
        pluginMessage: {
          type: "connectNodes",
          data: { fromNodeId, toNodeId, fromDirection, toDirection }
        }
      }, "*");
    };

    // 监听来自widget的消息
    window.addEventListener("message", (event) => {
      const msg = event.data.pluginMessage;
      if (!msg) return;
      
      if (msg.type === "nodeInfo") {
        // 单个节点信息
        const nodeInfo = msg.data;
        if (nodeInfo) {
          // 更新或添加节点到列表
          const existingIndex = nodes.findIndex(n => n.id === nodeInfo.nodeId);
          if (existingIndex >= 0) {
            nodes[existingIndex] = nodeInfo;
          } else {
            nodes.push(nodeInfo);
          }
          updateNodeSelects();
        }
      } else if (msg.type === "nodesList") {
        nodes = msg.data || [];
        updateNodeSelects();
      } else if (msg.type === "connectionsList") {
        connections = msg.data || [];
        updateConnectionList();
      }
    });

    // 初始化 - 延迟一下确保UI已准备好
    setTimeout(() => {
      refreshNodes();
    }, 100);
  </script>
</body>
</html>