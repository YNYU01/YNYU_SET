<html data-plugin="fig" data-theme="dark" data-language="Zh">
<head>
  <link rel="stylesheet" href="https://cdn.jsdelivr.net.cn/gh/YNYU01/YNYU_SET@b69de11f6a667f2934cf82cd067412e3e9b3895b/builds/yn_style.css"  >
  <!-- INLINE_CSS -->
  <style>
@font-face {
  font-family: Shanggu Sans;
  src: url("https://cdn.jsdelivr.net.cn/gh/YNYU01/YNYU_SET@ba19c5d927f0c9cc1bb1647b224fb58667102074/fonts/other/ShangguSans-Regular.otf") format('opentype');
  font-weight: 400;
  font-display: swap;;
}

:root{
  --top-h: 24px;
}

/*--ç»„ä»¶ä¿®æ”¹*/
.show-next{
  transform: rotate(90deg);
  margin:0 -2px 0 2px;
  cursor: pointer;
}

input[type="checkbox"]:checked + .show-next{
  transform: rotate(-30deg);
  margin:0 2px 0 -2px;
}

.show-next::after {
  transform-origin: 40% 40%;
}

input[type="checkbox"]:checked + .show-next::after {
  content: 'ğŸ“¢';
  font-size: 16px;
  display: flex;
  align-items: center;
  justify-content: center;
  width: 100%;
  height: 100%;
  top: -2px;
  left: 2px;
  transform: none;
  background: none;
}

#tips-all{
  display: none;
  justify-content: center;
  align-items: center;
  position: absolute;
  width: 100%;
  bottom: 80px;
  margin: auto;
  animation: boxUp 0.2s;
  z-index: 20;
  pointer-events: none;
}

.tips-all-text{
  color: #ffffff;
  background: rgba(0, 0, 0, 0.8);
  padding: 4px 8px;
  border-radius: 8px;
}

.switch [data-swi-icon]{
  transition:transform 0.2s ease-out;
  }
  
input[type="checkbox"]:checked+.switch [data-swi-icon]{
  transform: translateX(var(--swi-h,18px));
}
/*ç»„ä»¶ä¿®æ”¹--*/

html[data-language="En"] {
  --mainFontSize: 10px;
}

html[data-language="Zh"] {
  --mainFontSize: 12px;
}

body{
  font-size: var(--mainFontSize);
}

#top{
  height: var(--top-h);
  position: relative;
}

#top::after{
  content: '';
  position: absolute;
  bottom: -1px;
  width: 100%;
  height: 1px;
  background: var(--boxBod);
  opacity: 0.5;
}

#bottom{
  height: 32px;
  bottom: 0;
}

#bottom::after{
  content: '';
  position: absolute;
  top: -1px;
  width: 100%;
  height: 1px;
  background: var(--boxBod);
  opacity: 0.5;
}

[data-tab-for="page"]{
  gap: 4px;
  padding-left: 2%;
}

.tab-top{
  padding: 2px 4px;
  border-radius: 4px;
  text-transform: capitalize;
  opacity: 0.5;
}

input[type="checkbox"]:checked + .tab-top{
  opacity: 1;
  background: var(--swi-bak);
}

[data-page-id="page"]{
 height: calc(100vh - 76px);
}

[data-tv-box]{
  display: flex;
  align-items: center;
  width: calc(100% - 10px);
  font-size: 10px;
}

.btn-big{
  width: 12px;
  height: 12px;
  margin-left: 2px;
  cursor: pointer;
}

input[type="checkbox"]:checked+.btn-big .path1 {
  transform: translateY(6px) translateX(-6px);
}

input[type="checkbox"]:checked+.btn-big .path2 {
  transform: translateX(6px) translateY(-6px);
}

[data-side]{
  left: 0;
  z-index: 3;
  /*animation: topTabUp 0.5s;*/
}

[data-side-mix]{
  width: 200px;
  background: var(--boxGry);
  padding: 10px 10px;
  justify-content: space-between;
  display: none;
  overflow: hidden;
}


@keyframes sideUp {
  0%{
    width: 0;
  }
  100%{
    width: 200px;
  }
}

@keyframes sideOver {
  0%{
    width: 200px;
    padding-left: 10px;
  }
  100%{
    width: 0;
    padding-left: 0px;
  }
}

@keyframes topTabUp {
  0%{
    transform: translateY(calc(var(--top-h) * -1));
  }
  100%{
    transform: translateY(0%);
  }
}

[data-icon-more]{
  transition: transform 0.4s;
}

input[type="checkbox"]:checked + label [data-icon-more]{
  transform: rotate(90deg);
}

[data-icon-more-path]{
  stroke: var(--mainColor);
  stroke-width: 2;
  transition: transform 0.2s;
}

[data-icon-more-path="1"]{
  transform: matrix(1,0,0,1,1,4);
}
[data-icon-more-path="2"]{
  transform: matrix(1,0,0,1,1,10);
}
[data-icon-more-path="3"]{
  transform: matrix(1,0,0,1,1,16);
}

input[type="checkbox"]:checked + label [data-icon-more-path="1"]{
  transform: matrix(0.7,0.7,-0.7,0.7,3.64,3.64);
}
input[type="checkbox"]:checked + label [data-icon-more-path="2"]{
  transform: matrix(0.1,0,0,1,10,10);
}
input[type="checkbox"]:checked + label [data-icon-more-path="3"]{
  transform: matrix(0.7,-0.7,0.7,0.7,3.64,16.37);
}

#btn-theme{
  width: 20px;
  height: 20px;
  padding: 4px;
  box-sizing: border-box;
  background: var(--swi-bak);
  border-radius: 4px;
  border: 1px solid var(--boxBod);
}

.btn-more{
  width: 16px;
  height: 16px;
  opacity: 0.6;
  cursor: pointer;
}

[data-mainset-side]{
  gap:4px;
  padding: 10px 10px 10px 0;
  border-top: 1px solid var(--boxBod);
}

[data-language="Zh"] [data-any="en"]{
  display: none;
}

[data-language="En"] [data-any="zh"]{
  display: none;
}

[data-resize]{
  content: '';
  position: absolute;
  cursor:nw-resize;
  bottom: 2px;
  right: 2px;
  width: 8px;
  height: 8px;
  background: linear-gradient(to top left,
  transparent 20%,
  var(--boxBod) 21%,
  var(--boxBod) 25%,
  transparent 26%,
  transparent 45%,
  var(--boxBod) 46%,
  var(--boxBod) 50%,
  transparent 51%);
}

[data-tv-box]{
  --mainColor: #b9b9b9;
  color: var(--mainColor);
}

[data-theme="dark"] [data-tv-box]{
  --mainColor: #9b9b9b;
}

[data-tv-cut],
[data-tv-box] .show-next{
  height: 18px;
  border-radius: 10px;
  background: rgba(0, 0, 0, 0.8);
}

@media (max-width:240px) {
  [data-any="vw240"]{
    display: none;
  }
}

</style>
  <script src="https://cdn.jsdelivr.net.cn/gh/YNYU01/YNYU_SET@b69de11f6a667f2934cf82cd067412e3e9b3895b/public/run.js"></script>
  <!-- INLINE_RUN -->
  <script>
if (ISPLUGIN){
  ROOT.setAttribute('data-mobile','false');
  ISMOBILE = false;
  toolMessage(['userTheme','getlocal'],PLUGINAPP);
  toolMessage(['userLanguage','getlocal'],PLUGINAPP);
  toolMessage(['tabPick','getlocal'],PLUGINAPP);
}

window.addEventListener('message',(message)=>{
  let isPluginMessge = message.data && message.data.type && message.data.type == 'figma-ex-page-info';
  if(!isPluginMessge){
    let messages = message.data.pluginMessage.pluginMessage || ['',''];
    let info = messages[0];
    let type = messages[1];
    switch (type){
      case 'userTheme': info == 'light' ? setTheme(true,false) : setTheme(false,false);break
      case 'userLanguage': info == 'Zh' ? setLanguage(true) : setLanguage(false);break
      case 'tabPick': viewPage(info);break
    }
  }
});

/**
 * @param {Array} data - [info,typeName/skillName]
 * @param {string} app - PLUGINAPP(éœ€å®šä¹‰) | 'fig' | 'mg'
 */
function toolMessage(data,app){
  switch (app){
    case 'fig': parent.postMessage({pluginMessage:data},"*"); break
    case 'mg' : parent.postMessage(data,"*");break
  }
}

</script>
</head>

<body class="noselect df-ffc df-cc">
  <!--é¡¶éƒ¨-->
  <div id="top" class="w100 df-sc">
    <div></div>
    <div class="df-cc" style="gap:4px; margin-right: 2%; font-size: 12px;">
      <input id="big" type="checkbox">
      <label for="big" class="btn-big df-cc">
        <btn-show></btn-show>
      </label>
    </div>
  </div>
  <!--å…¨å±€tips-->
  <div id="tips-all">
    <div id="tips-all-text" class="tips-all-text" ></div>
  </div>
  <!--ä¾§è¾¹æ -->
  <div data-side data-any="vw240" class="df pos-a" style="top: 0; left: 0; --fill: var(--mainColor)">
    <div data-side-mix class="df-ffc" style="height: calc(100vh - 20px)">
      <div class="h100"></div>
      <div data-mainset-side class="df-sc">
        <a href="https://www.ynyuset.cn" target="_blank" class="fl1 df-lc" style="gap: 2px; color: var(--mainColor); font-size: 10px;">
          Â©2024-2025 
          <set-en data-any="en" class="fl0" style="height: 20px; margin-top: -2px;"></set-en>
          <set-zh data-any="zh" class="fl0" style="height: 20px; margin-top: -3px;"></set-zh>
        </a>
        <div class="df-lc" style="gap: 4px;">
          <div id="btn-theme">
            <input id="theme-1" data-theme-check type="checkbox" checked="true">
            <label for="theme-1" class="btn-theme" style="position: relative;">
              <btn-theme></btn-theme>
            </label>
          </div>
          <input id="language-1" data-language-check type="checkbox" checked="true"/>
          <label for="language-1" class="switch pos-a" style="--swi-h:18px; --swi-r:6px; --swi-af:var(--mainColor);">
            <div class="pos-a" data-swi-icon style="top:3px; left: 2px; width: 11px; height: 11px; z-index: 2;">
              <svg style="margin: auto 1px;" xmlns="http://www.w3.org/2000/svg" width="100%" height="100%" viewBox="0 0 22 22">
                <path fill="var(--boxBod)" d="M16.36 14c.08-.66.14-1.32.14-2s-.06-1.34-.14-2h3.38c.16.64.26 1.31.26 2s-.1 1.36-.26 2m-5.15 5.56c.6-1.11 1.06-2.31 1.38-3.56h2.95a8.03 8.03 0 0 1-4.33 3.56M14.34 14H9.66c-.1-.66-.16-1.32-.16-2s.06-1.35.16-2h4.68c.09.65.16 1.32.16 2s-.07 1.34-.16 2M12 19.96c-.83-1.2-1.5-2.53-1.91-3.96h3.82c-.41 1.43-1.08 2.76-1.91 3.96M8 8H5.08A7.92 7.92 0 0 1 9.4 4.44C8.8 5.55 8.35 6.75 8 8m-2.92 8H8c.35 1.25.8 2.45 1.4 3.56A8 8 0 0 1 5.08 16m-.82-2C4.1 13.36 4 12.69 4 12s.1-1.36.26-2h3.38c-.08.66-.14 1.32-.14 2s.06 1.34.14 2M12 4.03c.83 1.2 1.5 2.54 1.91 3.97h-3.82c.41-1.43 1.08-2.77 1.91-3.97M18.92 8h-2.95a15.7 15.7 0 0 0-1.38-3.56c1.84.63 3.37 1.9 4.33 3.56M12 2C6.47 2 2 6.5 2 12a10 10 0 0 0 10 10a10 10 0 0 0 10-10A10 10 0 0 0 12 2"></path>
              </svg>
            </div>
          </label>
        </div>
      </div>
    </div>
    
    <div class="df-cc" style="width: 24px; height: 24px; background: var(--boxGry);">
      <input id="btn-more" type="checkbox" />
      <label for="btn-more" class="btn-more" >
        <svg data-icon-more width="100%" height="100%" viewBox="0 0 20 20">
          <g data-icon-more-path="1" >
            <path fill="none" d="M18 0L0 0"></path>
          </g>
          <g data-icon-more-path="2">
            <path fill="none" d="M18 0L0 0"></path>
          </g>
          <g data-icon-more-path="3">
            <path fill="none" d="M18 0L0 0"></path>
          </g>
        </svg>
      </label>
    </div>
  </div>
  <!--ä¾§è¾¹æ é®ç½©-->
  <div data-side-mask class="wh100 pos-a" style="display: none;  z-index: 2">
    <div class="wh100" style="background: rgba(0,0,0,0.3); backdrop-filter: blur(2px);"></div>
  </div>
  <!--åŠŸèƒ½é¡µé¢-->
  <div class="df-ffc w100 df-cc">
    <div data-page-id="page" class="df-ffc" data-tab-pick="create">
      <div data-page-name="åˆ›å»º" data-page-name-en="create" data-page-main="true" data-page-tabclass="tab-top" class="df-cc wh100" style="display: flex;">
        
      </div>
      <div data-page-name="å¯¼å‡º" data-page-name-en="export" data-page-main="false" data-page-tabclass="tab-top" class="df-cc wh100" style="display: none;">
        
      </div>
      <div data-page-name="è¡¨å•" data-page-name-en="table" data-page-main="false" data-page-tabclass="tab-top" class="df-cc wh100" style="display: none;">
        
      </div>
      <div data-page-name="å˜é‡" data-page-name-en="variable" data-page-main="false" data-page-tabclass="tab-top" class="df-cc wh100" style="display: none;">
        
      </div>
      <div data-page-name="ç¼–è¾‘" data-page-name-en="editor" data-page-main="false" data-page-tabclass="tab-top" class="df-cc wh100" style="display: none;">
        
      </div>
      <div data-page-name="æ›´å¤šåŠŸèƒ½" data-page-name-en="more tools" data-page-main="false" data-page-tabclass="tab-top" class="df-cc wh100" style="display: none;">
        
      </div>
    </div>
  </div>
  <!--å…¬å‘Šæ -->
  <div data-tv-box data-any="vw240"  class="df-lc">
    <div data-tv-cut class="TV df-lc" >
      <div data-tv="true" class="df-lc" style="--tv-w: -29ch; --tv-s: 37s;">
        <div style="min-width: 7ch;" data-en-text="ğŸ’¬NOTICE:">ğŸ’¬å…¬å‘Š:</div>
        <div style="min-width: 22ch;" data-en-text="Please note the following">å…¬å‘Šå†…å®¹å…¬å‘Šå†…å®¹å…¬å‘Šå†…å®¹</div>  
      </div>  
    </div>
    <input type="checkbox" id="TV_show"/>
    <label for="TV_show"class="show-next df-cc fl0" style="width: 18px;">
    </label> 
  </div>
  <!--åº•éƒ¨-->
  <div id="bottom" class="df-lc w100 pos-a">
    <div class="df ovx noscrollbar" data-tab="auto" data-tab-for="page" style="padding: 6px 4px;">
      <!--è‡ªåŠ¨å¡«å……tab-->
    </div>
  </div>
  <!--æ’ä»¶ç«¯è°ƒæ•´å¤§å°-->
  <div data-resize></div>
  
  <script src="https://cdn.jsdelivr.net.cn/gh/YNYU01/YNYU_SET@b69de11f6a667f2934cf82cd067412e3e9b3895b/builds/yn_comp.js"></script>
  <script src="https://cdn.jsdelivr.net.cn/gh/YNYU01/YNYU_SET@b69de11f6a667f2934cf82cd067412e3e9b3895b/builds/yn_tool.js"></script>
  <script src="https://cdn.jsdelivr.net.cn/gh/YNYU01/YNYU_SET@b69de11f6a667f2934cf82cd067412e3e9b3895b/public/compressor.min.js"></script>
  <script src="https://cdn.jsdelivr.net.cn/gh/YNYU01/YNYU_SET@b69de11f6a667f2934cf82cd067412e3e9b3895b/public/jszip.js"></script>
  <script src="https://cdn.jsdelivr.net.cn/gh/YNYU01/YNYU_SET@b69de11f6a667f2934cf82cd067412e3e9b3895b/public/graph.js"></script>
  <!-- INLINE_JS -->
  <script>
/**
 * åŠ¨æ€ç”Ÿæˆå°åŠŸèƒ½åˆ—è¡¨
 * åŠŸèƒ½å±‚çº§ï¼šæ¨¡å—>åŠŸèƒ½ç‚¹/é›†>è¡¨å•/æŒ‰é’®ï¼Œæ¨¡å—ç”¨äºtabåˆ‡æ¢ï¼ŒåŠŸèƒ½ç‚¹/é›†å¯æŸ¥çœ‹è¯´æ˜
 * æ–‡æ¡ˆç±»å‹éœ€ç”¨['ä¸­æ–‡XXX','EnglishXXX']åˆ†åˆ«è®°å½•
 * è¡¨å•ç±»å‹åŸºäºyn_comp.jsç»„ä»¶åº“
 * è¡¨å•é€è¡Œè®°å½•ï¼ŒCSSæ§åˆ¶é»˜è®¤é—´éš™å’Œè‡ªé€‚åº”å®½åº¦ï¼Œåˆ†éš”é—´éš™éœ€åŠ å¤šåˆ†éš”å¯¹è±¡,å¯è®¾ç½®åˆ†éš”å€¼ï¼Œä¸è®¾ç½®åˆ™æŒ‰é»˜è®¤é—´éš™ä¸¤å€
 */
const skillList = [
  {
    icon: '',/*svgæ³¨å†Œç»„ä»¶*/
    title: ['',''],/*ä¸€çº§åŠŸèƒ½æ¨¡å—*/
    skills: [
      {
        name: ['',''],/*äºŒçº§åŠŸèƒ½å*/
        tips: ['',''],/*åŠŸèƒ½è¯´æ˜*/
        comps:[/*åŠŸèƒ½æŒ‰é’®ï¼Œé€è¡Œ*/
          [/*å•è¡Œ*/
            {
              type: "SELECT",/* BUTTON | INPUT_ICON | RANGE_INT | SELECT | */
              buttonMain: false,/*å¦‚ä¸ºä¸»æŒ‰é’®åˆ™ç‰¹æ®Šæ ·å¼ */
              selectOption:[
                ['',''],
                ['',''],
              ],
              isView: true,/*æ˜¯å¦å¤–æ˜¾*/
              isVIP: false,/*æ˜¯å¦é«˜çº§åŠŸèƒ½*/
            },
            {
              type: "GAP",
              gap: null,
              isView: true,
              isVIP: false,
            },
          ],
        ], 
        isStart: false,/*ç”¨æˆ·æ”¶è—åä¿å­˜æœ¬åœ°æ•°æ®å¹¶ç½®é¡¶*/
      },
    ],
  },
]

/**
 * å…‹éš†åˆ°å¸¸ç”¨åŠŸèƒ½
 */
let userSkillStart = ['äºŒçº§åŠŸèƒ½å','äºŒçº§åŠŸèƒ½å']

const UI_MINI = [200,460];
const sideMix = document.querySelector('[data-side-mix]');
const sideMask = document.querySelector('[data-side-mask]');
const btnMore = document.getElementById('btn-more');
const btnResize = document.querySelector('[data-resize]');
const btnBig = document.getElementById('big')

let isResize = false;
let reStartW,reStartH,reStartX,reStartY;

window.addEventListener('load',()=>{
  if(window.innerWidth < 300){
    TV_MOVE = true;
  } else {
    TV_MOVE = false;
  };
  reTV();
  loadFont();
});

window.addEventListener('resize',()=>{
/*é˜²æŠ–*/
let MOVE_TIMEOUT;
if(MOVE_TIMEOUT){
    clearTimeout(MOVE_TIMEOUT)
};
MOVE_TIMEOUT = setTimeout(()=>{
  if(window.innerWidth < 300){
    TV_MOVE = true;
  } else {
    TV_MOVE = false;
  }
},500);
});

let loadFontAfter = [
  "data-en-text",
  "data-en-input",
  "data-en-placeholder",
  "data-turnto",
  "data-back",
]

function loadFont(){
  setTimeout(()=>{
    loadFontAfter.forEach(key => {
      let nodes = document.querySelectorAll(`[${key}]`);
      nodes.forEach(item => {
        item.style.fontFamily = '"Shanggu Sans", Arial, Helvetica, sans-serif';
      })
    });
  },500);
}

//ä¾§è¾¹æ å±•å¼€
btnMore.addEventListener('change',(event)=>{
  if(event.target.checked){
    sideMix.style.display = 'flex';
    sideMask.style.display = 'block';
    sideMix.style.animation = 'sideUp 0.3s ease-out';
    sideMask.style.animation = 'loadOp 0.3s ';
  } else {
    sideMix.style.animation = 'sideOver 0.3s ease-out';
    sideMask.style.animation = 'overOp 0.3s ease-out';
    setTimeout(()=>{ 
      sideMix.style.display = 'none'
      sideMask.style.display = 'none'
    },280)
  }
});
//ä¾§è¾¹æ å…³é—­
document.addEventListener('click',(event)=>{
  if(!sideMix.contains(event.target) && sideMask.style.display !== 'none' && sideMix.style.display !== 'none' && btnMore.checked == true ){
    btnMore.checked = false;
    let inputEvent = new Event('change',{bubbles:true});
    btnMore.dispatchEvent(inputEvent);
  }
});
//ç¼©æ”¾çª—å£
btnResize.addEventListener('mousedown',(event)=>{
  isResize = true;
  let reNodeStyle = document.defaultView.getComputedStyle(ROOT);
  reStartW = parseInt(reNodeStyle.width,10);
  reStartH = parseInt(reNodeStyle.height,10);
  reStartX = event.clientX;
  reStartY = event.clientY;
  //console.log(reStartW,reStartH)
  document.addEventListener('mousemove',(e)=>{
    if(isResize){
      let w = reStartW + e.clientX - reStartX;
      let h = reStartH + e.clientY - reStartY;
      w = Math.max(w,UI_MINI[0]);
      h = Math.max(h,UI_MINI[1]);
      toolMessage([[w,h],'resize'],PLUGINAPP);
      /*//
      console.log(w,h)
      ROOT.style.width = w;
      ROOT.style.height = h;
      //*/
      
      /*é˜²æŠ–*/
      let MOVE_TIMEOUT;
      if(MOVE_TIMEOUT){
          clearTimeout(MOVE_TIMEOUT)
      };
      MOVE_TIMEOUT = setTimeout(()=>{
        if(w > UI_MINI[0] || h > UI_MINI[1]){
          btnBig.checked = true;
        } else {
          btnBig.checked = false;
        }
      },500);
    }
  });
  document.addEventListener('mouseup',()=>{
    isResize = false;
  })
})
//æ‰“å°æ‰€é€‰å¯¹è±¡
document.getElementById('bottom').addEventListener('dblclick',()=>{
  toolMessage(['','getnode'],PLUGINAPP)
})
//æœ€å¤§åŒ–çª—å£
btnBig.addEventListener('change',()=>{
  if(btnBig.checked){
    toolMessage([true,'big'],PLUGINAPP)
  }else{
    toolMessage([false,'big'],PLUGINAPP)
  }
})
//tabæ»šåŠ¨
let tabPage = document.querySelector('[data-tab-for="page"]');
let tabScroll = false;
let tabStartX,tabScrollLeft;
tabPage.addEventListener('mousedown',(event)=>{
  tabScroll = true;
  tabStartX = event.clientX;
  tabScrollLeft = tabPage.scrollLeft;  
  document.addEventListener('mousemove',(e)=>{
    if(tabScroll){
      let move = e.clientX - tabStartX;
      tabPage.scrollLeft = tabScrollLeft - move;
    }
  });
  document.addEventListener('mouseup',()=>{
    tabScroll = false;
  })
});
//å…¬å‘Šå±•å¼€æ”¶èµ·
document.getElementById('TV_show').addEventListener('change',() => {showNext('TV_show','[data-tv-cut]','flex')})


/**
 * æ¨¡æ‹Ÿç‚¹å‡»tabåˆ‡æ¢é¡µé¢ï¼Œæµ‹è¯•æ—¶æ›´æ–¹ä¾¿ï¼Œèƒ½ç›´æ¥æ˜¾ç¤ºç›®æ ‡é¡µé¢
 * @param {string} name - åº”è¯¥ä¼ å…¥tabçš„è‹±æ–‡å
 */
function viewPage(name){
  let tab = document.getElementById(`tab_${name}_0`);
  tab.checked = true;
  let inputEvent = new Event('change',{bubbles:true});
  tab.dispatchEvent(inputEvent);
}

/*ç›‘å¬ç»„ä»¶çš„è‡ªå®šä¹‰å±æ€§å€¼ï¼Œå˜åŒ–æ—¶è§¦å‘å‡½æ•°ï¼Œç”¨äºå·²ç»ç»‘å®šäº‹ä»¶ç”¨äºè‡ªèº«çš„ç»„ä»¶ï¼Œå¦‚é¢œè‰²é€‰æ‹©å™¨ã€æ»‘å—è¾“å…¥æ¡†ç»„åˆã€ä¸ºç©ºè‡ªåŠ¨å¡«å……æ–‡æ¡ˆçš„è¾“å…¥æ¡†ã€å¯¼èˆªtabã€ä¸‹æ‹‰é€‰é¡¹ç­‰*/
let observer = new MutationObserver((mutations) => {
  mutations.forEach((mutation) => {
    if(mutation.type === 'attributes'){
      switch(mutation.attributeName){
        case 'data-tab-pick':getUserTab(mutation.target); break;
      }
    }
  })
});
let userEvent_tab = document.querySelectorAll('[data-tab-pick]');
userEvent_tab.forEach(item => {
  let config = {attributes:true,attributeFilter:['data-tab-pick']};
  observer.observe(item,config);
});

/**
 * @param {Element} node -å¸¦æœ‰data-tab-pickå€¼çš„å…ƒç´ ï¼Œç”¨äºè®°å½•ç”¨æˆ·å…³é—­å‰æ‰€é€‰çš„tab
 */
function getUserTab(node){
  let tabPick = node.getAttribute('data-tab-pick').split('tab_')[1]
  if(tabPick){
    storageMix.set('tabPick',tabPick);
  }
}

function addSkill(){
  skillList.forEach(model => {
    let skillModel = document.createElement('div');
    skillModel.setAttribute('data-skillModel',model.title[1]);

    let tabSkill = document.createElement('div');
    tabSkill.setAttribute('data-tabSkill',model.title[1]);

    page_skills.appendChild(skillModel);
    tab_skills.appendChild(tabSkill)
  })
  userSkillStart.forEach(skill => {

  })
}

//ç”Ÿæˆå¯¼å‡ºæ ‡ç­¾
function addExport(frameDataOld,frameDataNew,isNew) {
  //console.log(frameData)
  var index = 0;
  if(isNew == 'new'){
    exportNum = 0;
    tagsContainer2.innerHTML = "";
    frameData = frameDataNew;
  }else{
    frameData = frameDataNew;
    index = exportNum//é¿å…åºå·é”™ä¹±
  }

  for (var i = 0; i < frameData.length; i++) {
    var option = `<option value="` + frameData[i].type + `">` + frameData[i].type + `</option>`
    var options = "";
    typeAllow.forEach(item => {
      if( item != frameData[i].type){
        options += `<option value="` + item + `">` + item + `</option>`
      }
    })
    var filetype = `<select id="imgtype-` + (i + index) + `" class="input-btn-skill" 
    name="æ–‡ä»¶æ ¼å¼"
    style="width: 60px; min-width: 60px; height:22px; width: 14ch; color: var(--mainColor); font-size: 12;" 
    onchange="
    var name = document.getElementById('fileName-' +` + (i + index) + `);
    var text = name.value.split('.')[0] + '.' + this.value; 
    name.value = text;
    message([[this.value,'` + frameData[i].id + `'],'exportTypeSet']);
    imgExportData[`+ (i + index) +`].fileName = text ">
      `+ option + options +`
    </select>`
    var info = `<div class="info">
      <span style="opacity: 0.5;">` + ((i + index) + 1) + `.</span>
      <input type="text" class="input-nobg" id="fileName-` + (i + index) + `"value="` + frameData[i].name + `.` + frameData[i].type + `" 
      onKeyPress="if(window.event.keyCode==13) this.blur()" 
      onchange="imgExportData[`+ (i + index) +`].fileName = this.value; 
      var type = this.value.split('.')[1] ? this.value.split('.')[1].toLowerCase() : '';
      if (type && typeAllow.includes(type)){
      document.getElementById('imgtype-' +` + (i + index) + `).value = type;
      } else {
       this.value = this.value.split('.')[0] + '.' + document.getElementById('imgtype-' +` + (i + index) + `).value;
      }
      
      //console.log(imgExportData.map(item => item.fileName))"/>
    </div>`;
    var size = '<span id="imgsize-'+ (i + index) +'" style="color:var(--mainColor2);opacity: 0.8;"></span>';
    var setsize = `<div class="input-btn-skill" style="width: 60px; min-width: 60px; height:20px" >
      <input  id="exportSize-` + (i + index) + `" type="text" class="input-btn-skill" 
      style="border:0px; height: 18px;" value="` + frameData[i].s + `" 
      onKeyPress="if(window.event.keyCode==13) this.blur()" 
      onchange="message([[this.value,'` + frameData[i].id + `'],'exportSizeSet']);
      imgExportData[`+ (i + index) +`].s = this.value;
      console.log(imgExportData.map(item => item.s))"/>
      <div class="input-btn-skill" style="border:0px; width:30px; border-radius: 0px ;background-color: var(--boxGry); opacity: 0.8;  color:var(--mainColor)">k</div>
      </div>`
    var chk = `
    <input id="chk-export-` + (i + index) + `" type="checkbox" style="display: none;" />
    <label for="chk-export-` + (i + index) + `" class="chk-export-key set" style="width:100%; display: flex;align-items: center;gap: 4px;">
      `+ info +`
      <svg style="display:var(--export-edit);" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" fill="none" version="1.1" width="14" height="14" viewBox="0 0 10 10">
          <g transform="matrix(0.8660253882408142,0.5,-0.5,0.8660253882408142,1.3172291698792833,-2.3877065935394057)">
            <path fill="var(--has)" d="M8.4255957421875,1.264617919671875L8.4255957421875,6.264129638671875Q8.4255957421875,6.313379638671875,8.4159857421875,6.361679638671875Q8.4063857421875,6.409969638671875,8.3875357421875,6.455469638671875Q8.3686957421875,6.500969638671875,8.3413357421875,6.541909638671875Q8.3139757421875,6.582859638671875,8.2791557421875,6.617679638671875Q8.244325742187499,6.652499638671875,8.2033857421875,6.679859638671875Q8.1624357421875,6.707219638671875,8.1169357421875,6.726069638671875Q8.0714457421875,6.744909638671875,8.0231457421875,6.754519638671875Q7.9748457421875,6.764129638671875,7.9255957421875,6.764129638671875Q7.8640457421875,6.764129638671875,7.8043357421875,6.749199638671875L4.9928757421875,6.046379638671875Q4.9117407421875,6.026099638671875,4.8416217421875,5.980519638671875Q4.7715037421875,5.934939638671875,4.7200357421875,5.869019638671875Q4.6685667421875,5.803099638671875,4.6413517421875,5.724019638671875Q4.6141357421875,5.644939638671875,4.6141357421875,5.561309638671875Q4.6141357421875,5.512059638671875,4.6237427421875,5.463759638671875Q4.6333507421875,5.415469638671875,4.6521957421875,5.369969638671875Q4.6710417421875,5.324469638671875,4.6984007421875,5.283519638671875Q4.7257607421875,5.2425796386718755,4.7605827421875,5.207759638671876Q4.7954047421875,5.172929638671874,4.8363507421875,5.145579638671875Q4.8772967421875,5.118219638671874,4.9227937421875,5.099369638671876Q4.9682907421875,5.080519638671875,5.0165906421875,5.0709196386718745Q5.0648900421875,5.061309638671875,5.1141357421875,5.061309638671875Q5.1756846421875,5.061309638671875,5.2353957421875,5.0762396386718756L5.2358847421875,5.076359638671875L7.4255957421875,5.623749638671875L7.4255957421875,1.264129638671875Q7.4255957421875,1.214883938671875,7.435205742187501,1.166584538671875Q7.4448157421875,1.118284638671875,7.4636557421875,1.0727876386718749Q7.4825057421875005,1.027290638671875,7.5098657421875,0.986344638671875Q7.5372257421875,0.945398638671875,7.5720457421875,0.910576638671875Q7.6068657421875,0.875754638671875,7.6478157421875,0.848394638671875Q7.6887557421874995,0.821035638671875,7.7342557421875,0.802189638671875Q7.7797557421875005,0.783344638671875,7.8280557421875,0.7737366386718749Q7.8763557421875,0.764129638671875,7.9255957421875,0.764129638671875Q7.9748457421875,0.764129638671875,8.0231457421875,0.7737366386718749Q8.0714457421875,0.783344638671875,8.1169357421875,0.802189638671875Q8.1624357421875,0.821035638671875,8.2033857421875,0.848394638671875Q8.244325742187499,0.875754638671875,8.2791557421875,0.910576638671875Q8.3139757421875,0.945398638671875,8.3413357421875,0.986344638671875Q8.3686957421875,1.027290638671875,8.3875357421875,1.0727876386718749Q8.4063857421875,1.118284638671875,8.4159857421875,1.166584538671875Q8.4255957421875,1.214883938671875,8.4255957421875,1.264129638671875L8.4255957421875,1.264617919671875Z" fill-rule="evenodd" fill-opacity="1"/>
          </g>
          <rect stroke="var(--boxBod)" x="0.5" y="0.5" width="9" height="9" rx="1.5" fill-opacity="0" stroke-opacity="1"  fill="none" stroke-width="1"/>
      </svg>
    </label>`
    var node = document.createElement('div');
    node.className = "tags-exports";
    node.id = "tags-exports-" + (i + index);
    node.innerHTML = '<div style="display:flex;gap:4px; align-items: center; width:100%;"><div class="btn-text" style="width:14px; height:14px; z-index:1;"onclick="this.parentNode.parentNode.remove();imgExportData['+ (i + index) +`].fileName = ''"><btn-close style=" opacity: 0.6;"></btn-close></div>` + chk + '</div><div class="set">' + size + '<div style="display:flex; gap:4px">'  + setsize + filetype + '</div></div>';
    tagsContainer2.appendChild(node);
    console.log("åˆ›å»ºå¯¼å‡ºï¼šç¬¬" + (i + index))
    exportNum++
  }

}
//åˆ é™¤å¯¼å‡ºæ ‡ç­¾
function noExport(e){
  if(e == 'all'){
    tagsContainer2.innerHTML = "";
    imgExportData = [];
    imgExportInfo = [];
    exportNum = 0;
    exportInfo.innerHTML = "[-- æœªé€‰ä¸­å®¹å™¨ --]"
  }
}

//ç”Ÿæˆå›¾ç‰‡æ ‡ç­¾
function addImg(imgsName) {
  tagsContainer1.innerHTML = "";
  var icon = `
  <svg xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" fill="none" version="1.1" width="20" height="16" viewBox="0 0 16 13.75732421875">
    <rect x="0" y="11.75732421875" width="16" height="2" rx="0" fill="#6E6E6E" fill-opacity="1"/>
    <g transform="matrix(0.7071067690849304,-0.7071067690849304,0.7071067690849304,0.7071067690849304,-2.3430887013528263,2.8286348765686853)">
      <rect x="2.242919921875" y="4.24267578125" width="6" height="9" rx="0" fill="#6E6E6E" fill-opacity="1"/>
      <path d="M5.242919921875,10.24267578125L6.727839921875,11.75775578125L8.242919921875,13.24267578125L6.727839921875,14.727595781249999L5.242919921875,16.24267578125L3.757999921875,14.727595781249999L2.242919921875001,13.24267578125L3.757999921875,11.75775578125L5.242919921875,10.24267578125Z" fill="#6E6E6E" fill-opacity="1"/>
    </g>
  </svg>
  `
  for (var i = 0; i < imgsName.length; i++) {
    //tagsContainer1.innerHTML += '<div class="tags-imports">' + icon + '<div style="width:4px"></div><input id="imgName-' + i + '" class="input-btn-skill" style="border: 0;text-align: left;" type="text" value="' + imgsName[i].name + '" onchange="imgsNameNew[' + i + '].name = this.value; if (!this.value){this.value = imgsName[' + i + '].name;console.log(`æ¢å¤åŸå‘½å`,imgsName[' + i + ']) }"/></div>';
    tagsContainer1.innerHTML += '<div class="tags-imports"><div style="width:4px">' + (i + 1) + '.' + imgsName[i] + '</div>';

  }
}

//ç”Ÿæˆç¼–è¾‘æ ‡ç­¾
function addEdit(type,copynode) {
  if(copynode){
    copyEdit = copynode.parentNode
  } else {
    editTag.scrollTop = 0;
  }
  if ( editTag.children.length !== 0){
    document.getElementById('chk-editor-' + editorPick).checked = false
  }
  var chk = '<input id="chk-editor-' + editorNum + '" type="checkbox" checked=" true" style="display:none" onchange="editorChk(this,' + editorNum + ')"/>'
  var main = type;
  var close = '<svg xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" fill="none" version="1.1" width="100%" height="100%" viewBox="0 0 17 17"><g><g><rect x="3.5" y="7.5" width="10" height="2" rx="0" fill="var(--mainColor)" fill-opacity="1"/></g><g><ellipse cx="8.5" cy="8.5" rx="8" ry="8" fill-opacity="0" stroke-opacity="1" stroke="var(--mainColor)" fill="none" stroke-width="1"/></g></g></svg>';
  var set = '<svg xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" fill="none" version="1.1" width="100%" height="100%" viewBox="0 0 18 18"><g><path d="M3.59452,1.67756L6.80722,3.70617L7.6445,0L10.3555,0L11.1928,3.70617L14.4055,1.67756L16.3224,3.59452L14.2938,6.80722L18,7.64451L18,10.3555L14.2938,11.1928L16.3224,14.4055L14.4055,16.3224L11.1928,14.2938L10.3555,18L7.64451,18L6.80722,14.2938L3.59452,16.3224L1.67756,14.4055L3.70617,11.1928L0,10.3555L0,7.64451L3.70617,6.80722L1.67756,3.59452L3.59452,1.67756ZM13.5,9C13.5,11.4853,11.4853,13.5,9,13.5C6.51472,13.5,4.5,11.4853,4.5,9C4.5,6.51472,6.51472,4.5,9,4.5C11.4853,4.5,13.5,6.51472,13.5,9ZM9.00006,11.9999C10.6569,11.9999,12.0001,10.6568,12.0001,8.99994C12.0001,7.34308,10.6569,5.99994,9.00006,5.99994C7.34321,5.99994,6.00006,7.34308,6.00006,8.99994C6.00006,10.6568,7.34321,11.9999,9.00006,11.9999Z" fill-rule="evenodd" fill="var(--mainColor)" fill-opacity="1"/></g></svg>';
  var copy = '<svg xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" fill="none" version="1.1" width="100%" height="100%" viewBox="0 0 11 11"><g><g><path d="M5,2L4,2L4,4L2,4L2,5L4,5L4,7L5,7L5,5L7,5L7,4L5,4L5,2Z" fill-rule="evenodd" fill="var(--mainColor)" fill-opacity="1"/></g><g><path d="M0,2.5L0,6.5Q0,7.53553,0.732233,8.26777Q1.29574,8.83127,2.03888,8.96112Q2.16872,9.70426,2.73223,10.2678Q3.46447,11,4.5,11L8.5,11Q9.53553,11,10.2678,10.2678Q11,9.53553,11,8.5L11,4.5Q11,3.46447,10.2678,2.73223Q9.70426,2.16872,8.96112,2.03888Q8.83127,1.29574,8.26777,0.732233Q7.53553,0,6.5,0L2.5,0Q1.46447,0,0.732233,0.732233Q0,1.46447,0,2.5ZM9,3.08099L9,6.5Q9,7.53553,8.26777,8.26777Q7.53553,9,6.5,9L3.08099,9Q3.18864,9.30996,3.43934,9.56066Q3.87868,10,4.5,10L8.5,10Q9.12132,10,9.56066,9.56066Q10,9.12132,10,8.5L10,4.5Q10,3.87868,9.56066,3.43934Q9.30996,3.18864,9,3.08099ZM1.43934,7.56066Q1,7.12132,1,6.5L1,2.5Q1,1.87868,1.43934,1.43934Q1.87868,1,2.5,1L6.5,1Q7.12132,1,7.56066,1.43934Q8,1.87868,8,2.5L8,6.5Q8,7.12132,7.56066,7.56066Q7.12132,8,6.5,8L2.5,8Q1.87868,8,1.43934,7.56066Z" fill-rule="evenodd" fill="var(--mainColor)" fill-opacity="1"/></g></g></svg>';
  if (type == 'HSL') {

  }
  if (type == 'é€è§†') {

  }
  if (type == 'æ¸å˜æ˜ å°„') {

  }
  if (type == 'æ»¤é•œ') {

  }
  if (type == 'å˜å½¢') {

  }
  var newEdit = document.createElement('div')
  newEdit.id = 'edits-'+ editorNum;
  newEdit.className = 'edits';
  newEdit.draggable = true;
  newEdit.innerHTML = chk + '<label for="chk-editor-' + editorNum + '" class="tags-editor"><div class="btn-text" style="width:10px;height:10px" onclick="if(this.parentNode.parentNode.firstChild.checked !== true) { this.parentNode.parentNode.parentNode.removeChild(this.parentNode.parentNode)};">' + close + '</div>' + type + '<div class="btn-text" style="width:10px;height:10px"></div></label>' +  '<div class="btn-text" style="width:10px;height:10px;position: absolute;top:7px;right:-8px;" onclick="addEdit(this.parentNode.innerText,this);">' + copy + '</div>'
  if ( editTag.children.length == 0 ){
    editTag.appendChild(newEdit)
  } else {
    if (copynode){
      editTag.insertBefore(newEdit,copyEdit)
    } else {
      editTag.insertBefore(newEdit,editTag.children[0])
    }
  }
  
  editorPick = editorNum;
  editorNum++;
  editsID()
}
function editorChk(node,e) {
    if (e !== editorPick) {
      document.getElementById('chk-editor-' + editorPick).checked = false;
      node.checked = true;
      editorPick = e;
      //console.log("new", editorPick, e)
    } else {
        //node.checked = false;
        //console.log("copy", editorPick, e)
        node.checked = true;
        //console.log("old", editorPick, e)

  }
}

//æ‹–æ‹½ç¼–è¾‘æ ‡ç­¾
function editsID(){  
  for (var i = 0; i < dragSources.length; i++) {
    dragSources[i].addEventListener('dragstart', function(event) {
      event.dataTransfer.setData("text/plain", event.target.id); 
      dropStartY = event.clientY;
    });
  
    dragSources[i].addEventListener('dragend', function(event) {
      event.dataTransfer.clearData("text/plain");
      dropEndY = event.clientY;
    });
  }
}

//æ¢¯åº¦å˜åŒ–ç±»å‹
function chkMix(type,checked){
  if (checked){
    mixType.push(type)
    //console.log(mixType)
  } else {

    if(mixType.includes(type)){
      mixType = mixType.filter(item => item !== type)
      //console.log(mixType)
    }
  }
}

//æŸ¥æ‰¾ç›¸ä¼¼ç±»å‹
function chkSame(type,checked){
  if (checked){
    searchSameType.push(type)
  } else {

    if(searchSameType.includes(type)){
      searchSameType = searchSameType.filter(item => item !== type)
    }
  }
}


//æŸ¥æ‰¾å¹¶é€‰ä¸­
function searchToRe(info) {
  message([{ area: searchArea, type: searchType, info: info }, 'searchToRe'])
}
//æŸ¥æ‰¾ç±»å‹
function chkSearchType(e) {
  if (e.id.split("-")[2] !== searchType) {
    message([{ area: searchArea, type: e.id.split("-")[2], info: searchInfo }, 'searchToRe'])
  }
  //var type = ["Text", "Component", "ComponentSet", "Font"]
  var type = ["Text", "Name"]

  for (var i = 0; i < type.length; i++) {
    document.getElementById("chk-for-" + type[i]).checked = false
  }

  e.checked = true
  searchType = e.id.split("-")[2]

}

//è¾“å…¥å€æ•°
function chkNum(e) {
  for (var i = 0; i < 4; i++) {
    document.getElementById('chk-num-list').style.opacity = '1';
    document.getElementById('chk-num-' + i).checked = false;
    document.getElementById('chk-num-' + e).checked = true;
  }
  document.getElementById('input-num-2').value = e + 1;
  document.getElementById('input-num-2').style.color = 'var(--boxBod)';
}

//é€‰æ‹©å€æ•°
function numSize() {
  for (var i = 0; i < 4; i++) {
    document.getElementById('chk-num-' + i).checked = false;

  }
  document.getElementById('input-num-2').style.color = 'var(--mainColor)';
  if (document.getElementById('input-num-2').value != "") {
    document.getElementById('chk-num-list').style.opacity = '0.5';
  } else {
    document.getElementById('chk-num-list').style.opacity = '1';
  }
}


//ç¼©æ”¾ä¸­å¿ƒ
function chkScaleCenter(e) {
  var center = ["TL", "TC", "TR", "CL", "CC", "CR", "BL", "BC", "BR"]
  for (var i = 0; i < center.length; i++) {
    document.getElementById("chk-scale-" + center[i]).checked = false
  }
  e.checked = true
  scaleCenter = e.id.split("-")[2]
}
//ç¼©æ”¾ç±»å‹
function chkScaleType(e) {
  var type = ["W", "H", "WH"]
  if (scaleType != e.id.split("-")[2]) {
    if (e.id.split("-")[2] == "WH") {
      document.getElementById("input-num-scale").value = 100;
    } else {
      document.getElementById("input-num-scale").value = 0;
    }
  }
  for (var i = 0; i < type.length; i++) {
    document.getElementById("chk-scale-" + type[i]).checked = false
  }

  e.checked = true
  scaleType = e.id.split("-")[2]

}
//ç­‰æ¯”ç¼©æ”¾
function chkScale(s) {
  //message([{center:scaleCenter,type:scaleType,value:s},'scaleSelf'])
}

//éå†å‰©ä½™æ ‡ç­¾ï¼Œè¯»å–å¯¹åº”æ•°ç»„çš„å®½é«˜ï¼Œå¹¶å‘å¾€ä¸»çº¿ç¨‹ï¼Œä»¥åˆ›å»ºç”»æ¿
function createrObj() {
  if (createrType == "frame") {
    console.log('å·²ä¸Šä¼ æ•°é‡ï¼š' + allFrame.length);

    for (var i = 0; i < allFrame.length; i++) {
      if (document.getElementById('tag-' + i).style.display !== 'none') {
        finalFrame.push(allFrame[i])
      }
    }
    console.log('å·²é€‰æ‹©ï¼š' + finalFrame.length);
    message([finalFrame, "createrframe"])
    finalFrame = [];
  }

}

//é€‰æ‹©è½¬çŸ¢é‡ç±»å‹
function chkVector(e) {
  for (var i = 0; i < 4; i++) {
    document.getElementById('chk-vector-' + i).checked = false;
    document.getElementById('chk-vector-' + e).checked = true;
  }
}

//è¿”å›å›¾ç‰‡å®½é«˜ä¿¡æ¯å’Œåˆ†æ®µï¼Œæ¢å¤å›¾ç‰‡åŸå°ºå¯¸
function imgURLtoWH(e) {
  var img = new Image();
  img.src = e.imgURL;
  img.onload = function () {
    message([{ w:img.width, h:img.height,index:e.index}, 'imgWH'])
  }
}

//æ·»åŠ å™ªç‚¹
function noise() {
  var noiseV = document.getElementById('input-num-tjzs').value
  var dom = document.createElement('canvas');
  dom.width = 512;
  dom.height = 512;
  var ctx = dom.getContext('2d');
  /*
  for (let y = 0; y < e[0]; y++) {
    for (let x = 0; x < e[1]; x++) {
      var color = Math.floor(Math.random() * 12 + (255 - 16)).toString(16);
      ctx.fillStyle = `#${color}${color}${color}`;
      ctx.fillRect(x, y, 1, 1);
    };
  };
  */
  for (var i = 0; i < noiseV * 65536; i++) {
    var x = Math.random() * dom.width;
    var y = Math.random() * dom.height;
    var color = Math.floor(Math.random() * 6 + (255 - 16)).toString(16);
    //ctx.fillStyle = `#${color}${color}${color}`;
    ctx.fillStyle = 'rgba(' + Math.random() * 255 + ',' + Math.random() * 255 + ',' + Math.random() * 255 + ',' + (Math.random() * 0.5 + 0.5) + ')';
    ctx.beginPath();
    ctx.arc(x, y, Math.random() * 0.5, 0, 6);
    ctx.fill();
  }
  var url = dom.toDataURL(`image/png`, 0.6);
  return B64ToU8A(url.split(',')[1]);

}


function reCenter(event, node) {
  var XY = [event.pageX - node.x, event.pageY - node.y]
  var x = Math.round(inView.x + XY[0] * inView.s)
  var y = Math.round(inView.y + XY[1] * inView.s)
  singleClick = false;
  //console.log(node)
  //console.log(x,y,node.width,node.height,XY,inView.s)
  message([{ x: x, y: y }, "reCenter"])


}

//æ–œåˆ‡
function skew(e) {
  if (e) {
    var skewInfo = {
      x: parseInt(document.getElementById('input-num-skewW').value),
      y: parseInt(document.getElementById('input-num-skewH').value),
      w: parseInt(document.getElementById('input-num-scaleW').value),
      h: parseInt(document.getElementById('input-num-scaleH').value),
    }
    //console.log(skewInfo)
    message([skewInfo, 'skewSet'])
  } else {
    document.getElementById('slider-skewW').value = 0;
    document.getElementById('slider-skewH').value = 0;
    document.getElementById('input-num-skewW').value = 0;
    document.getElementById('input-num-skewH').value = 0;
    document.getElementById('slider-scaleW').value = 100;
    document.getElementById('slider-scaleH').value = 100;
    document.getElementById('input-num-scaleW').value = 100;
    document.getElementById('input-num-scaleH').value = 100;
    message([{ x: 0, y: 0, w: 100, h: 100 }, 'skewSet'])
  }

}


//////ä½¿ç”¨å…«å‰æ ‘æå–è‰²è¡¨//////
//å®šä¹‰å…«å‰æ ‘
class OctreeNode {
  constructor(level, parent) {
      this.level = level; // å½“å‰èŠ‚ç‚¹æ‰€åœ¨çš„å±‚æ¬¡
      this.pixelCount = 0; // å½“å‰èŠ‚ç‚¹åŒ…å«çš„åƒç´ æ•°é‡
      this.redSum = 0;     // çº¢è‰²åˆ†é‡çš„æ€»å’Œ
      this.greenSum = 0;   // ç»¿è‰²åˆ†é‡çš„æ€»å’Œ
      this.blueSum = 0;    // è“è‰²åˆ†é‡çš„æ€»å’Œ
      this.paletteIndex = -1; // å¦‚æœè¯¥èŠ‚ç‚¹æ˜¯ä¸€ä¸ªå¶å­èŠ‚ç‚¹ï¼Œè®°å½•å…¶åœ¨è°ƒè‰²æ¿ä¸­çš„ç´¢å¼•
      this.children = new Array(8); // å­èŠ‚ç‚¹æ•°ç»„
      this.parent = parent; // çˆ¶èŠ‚ç‚¹å¼•ç”¨
  }

  // åˆ¤æ–­å½“å‰èŠ‚ç‚¹æ˜¯å¦ä¸ºå¶å­èŠ‚ç‚¹
  isLeaf() {
      return this.children.every(child => child === undefined);
  }

  // è·å–å½“å‰èŠ‚ç‚¹çš„å¹³å‡é¢œè‰²
  getAverageColor() {
      if (this.pixelCount === 0) return [0, 0, 0];
      return [
          Math.round(this.redSum / this.pixelCount),
          Math.round(this.greenSum / this.pixelCount),
          Math.round(this.blueSum / this.pixelCount)
      ];
  }
}
//æ„å»ºå…«å‰æ ‘
class OctreeQuantizer {
  constructor(maxDepth) {
      this.maxDepth = maxDepth;
      this.root = new OctreeNode(0, null);
      this.palette = [];
      this.leafNodes = [];
  }

  // æ’å…¥ä¸€ä¸ªåƒç´ åˆ°å…«å‰æ ‘ä¸­
  insertPixel(pixel) {
      let node = this.root;
      for (let level = 0; level < this.maxDepth; level++) {
          const index = this.getOctantIndex(pixel, level);
          if (!node.children[index]) {
              node.children[index] = new OctreeNode(level + 1, node);
          }
          node = node.children[index];
      }
      node.pixelCount++;
      node.redSum += pixel[0];
      node.greenSum += pixel[1];
      node.blueSum += pixel[2];
  }

  // æ ¹æ®å½“å‰å±‚çº§è·å–å…«å‰æ ‘ç´¢å¼•
  getOctantIndex(pixel, level) {
      const bitShift = 8 - level - 1;
      const redBit = (pixel[0] >> bitShift) & 0x1;
      const greenBit = (pixel[1] >> bitShift) & 0x1;
      const blueBit = (pixel[2] >> bitShift) & 0x1;
      return (redBit << 2) | (greenBit << 1) | blueBit;
  }

  // åˆå¹¶å¶å­èŠ‚ç‚¹ä»¥å‡å°‘é¢œè‰²æ•°é‡
  reduceColors(targetColors) {
      while (this.leafNodes.length > targetColors) {
          let deepestNode = null;
          for (const leaf of this.leafNodes) {
              if (!deepestNode || leaf.level > deepestNode.level) {
                  deepestNode = leaf;
              }
          }
          this.mergeNode(deepestNode);
      }
  }

  // åˆå¹¶ä¸€ä¸ªèŠ‚ç‚¹
  mergeNode(node) {
      if (!node.isLeaf()) return;

      node.parent.pixelCount += node.pixelCount;
      node.parent.redSum += node.redSum;
      node.parent.greenSum += node.greenSum;
      node.parent.blueSum += node.blueSum;
      node.parent.children[node.getIndex()] = undefined;

      const index = this.leafNodes.indexOf(node);
      if (index !== -1) {
          this.leafNodes.splice(index, 1);
      }
      if (node.parent.isLeaf()) {
          this.leafNodes.push(node.parent);
      }
  }

  // ç”Ÿæˆè°ƒè‰²æ¿
  generatePalette() {
      this.leafNodes = [];
      this.collectLeaves(this.root);

      this.palette = this.leafNodes.map((leaf, index) => {
          leaf.paletteIndex = index;
          return leaf.getAverageColor();
      });
  }

  // æ”¶é›†æ‰€æœ‰å¶å­èŠ‚ç‚¹
  collectLeaves(node) {
      if (node.isLeaf()) {
          this.leafNodes.push(node);
      } else {
          for (const child of node.children) {
              if (child) {
                  this.collectLeaves(child);
              }
          }
      }
  }

  // è·å–è°ƒè‰²æ¿
  getPalette() {
      return this.palette;
  }
}

//è½½å…¥å›¾ç‰‡æ•°æ®
async function imgDataSet(imgDataOld,imgDataNew,isNew) {
  //console.log(imgExportInfo)
    if(isNew == "new"){
      imgExportData = [];
      var imgData = imgDataNew;
      for (var i = 0; i < imgData.length; i++) {
        var fileName = document.getElementById('fileName-' + i).value;
        var s = document.getElementById('exportSize-' + i).value;
        var colorBox = await getColorBox2(imgData[i]);//å…«å‰æ ‘æ³•
        imgExportData.push({u8a:imgData[i],src:U8AToB64(imgData[i]),fileName: fileName,s:s,col:colorBox})
        //console.log(imgExportData)
        if ( imgData[i].length/1000 <= s || s == ''){
          document.getElementById('imgsize-' + i).innerHTML =  Math.floor(imgData[i].length/1000)  + 'k /æ— éœ€å‹ç¼©' 
        } else {
          document.getElementById('imgsize-' + i).innerHTML =  Math.floor(imgData[i].length/1000) + 'k /<span style="color:var(--liColor1)">å¾…å‹ç¼©</span>' 
        }
    }
    }else{
      var imgData = imgDataNew;

      var index = exportNum - imgDataNew.length
      //console.log(exportNum,index)
      for (var i = 0; i < imgData.length; i++) {
        
        if ( document.getElementById('fileName-' + (i + index)) ){
          var fileName = document.getElementById('fileName-' + (i + index)).value
          var s = document.getElementById('exportSize-' + (i + index)).value
        } else {
          var fileName = ''
          var s = ''
        }
        var colorBox = await getColorBox2(imgData[i]);//å…«å‰æ ‘æ³• 
        imgExportData.push({u8a:imgData[i],src:U8AToB64(imgData[i]),fileName: fileName,s:s,col:colorBox})
      }

      //console.log(imgExportData)
      for (var i = 0; i < imgData.length; i++) {
        //console.log((i + index - 1))
        if ( imgExportData[(i + index)].u8a.length/1000 <= imgExportData[(i + index)].s || imgExportData[(i + index)].s == ''){
          document.getElementById('imgsize-' + (i + index)).innerHTML =  Math.floor(imgExportData[(i + index)].u8a.length/1000)  + 'k /æ— éœ€å‹ç¼©' 
        } else {
          document.getElementById('imgsize-' + (i + index)).innerHTML =  Math.floor(imgExportData[(i + index)].u8a.length/1000) + 'k /<span style="color:var(--liColor1)">å¾…å‹ç¼©</span>' 
        }
      }

    }

}
function getColorBox2(imgDatas){
  return new Promise((resolve, reject) => {
    var blob = new Blob([imgDatas], { type: 'image/png' }); 
    var url = URL.createObjectURL(blob);
    var img = new Image()
    img.src = url;

    img.onload = function(){
      var canvas = document.createElement('canvas');
      canvas.width = img.width;
      canvas.height = img.height;
      var ctx = canvas.getContext('2d')
      ctx.drawImage(img,0,0)
      var imageData = ctx.getImageData(0,0,img.width,img.height)
      var data = imageData.data;

      function quantizeImage(datas) {
        const octree = new OctreeQuantizer(3); // è®¾ç½®æœ€å¤§æ·±åº¦

        // æ’å…¥æ¯ä¸ªåƒç´ åˆ°å…«å‰æ ‘ä¸­
        for (let i = 0; i <  datas.length; i += 4) {
            const r =  datas[i];
            const g =  datas[i + 1];
            const b =  datas[i + 2];
            octree.insertPixel([r, g, b]);
        }

        // å‡å°‘é¢œè‰²æ•°é‡
        octree.reduceColors(128);

        // ç”Ÿæˆè°ƒè‰²æ¿
        octree.generatePalette();

        return octree.getPalette();
      }

      resolve(quantizeImage(imageData.data))

    }
  })
}

//å¯¼å‡ºå›¾ç‰‡ä¸ºzip
async function exportImg(){
  //console.log(666)
  if(imgExportData.length > 0){
    //console.log(777)
    try {
      //console.log(888)
      const compressedImages = await compressImages(imgExportData);
      createZipAndDownload(compressedImages);
    } catch (error) {
      console.error('å¤„ç†è¿‡ç¨‹ä¸­å‘ç”Ÿé”™è¯¯:', error);
    }
  }
  
}

//å•ä¸ªå›¾ç‰‡çš„å‹ç¼©
function compressImage(blob,quality,type,colorBox) {
   //console.log(u8a,quality,type)
    if (type == 'jpg' || type == 'jpeg'){
      //console.log(type)
      return new Promise((resolve, reject) => {
        //var blob = new Blob([u8a], { type: 'image/jpeg' });
        var file = new File([blob],'image.jpg',{type:'image/jpeg'})
        //console.log(file)
        new Compressor(file, {
          quality:quality/10,
          success(result) {
            resolve(result);
          },
          error(err) {
            reject(err);
          },
        });
      });
    } else if ( type == 'png') {
      var colorThief = new ColorThief();
      return new Promise((resolve, reject) => {
        //var blob = new Blob([u8a], { type: 'image/png' });    
        if(quality == 10){
          resolve(blob)
        } else {
          var url = URL.createObjectURL(blob);
          var img = new Image()
          img.src = url;

          img.onload = function(){
            var palette = colorThief.getPalette(img,20,1)//æå–å…³é”®é¢œè‰²
            var canvas = document.createElement('canvas');
            canvas.width = img.width;
            canvas.height = img.height;
            var ctx = canvas.getContext('2d')
            ctx.drawImage(img,0,0)
            var imageData = ctx.getImageData(0,0,img.width,img.height)
            var data = imageData.data;
            var colorcut = new Promise((resolve, reject) => {
              var deep = [0,2,6,8,12,14,16,18,20,22]
              var newStep = deep[Math.floor(10 - quality)];  

              function toStep(value,step){//é€šè¿‡æ­¥é•¿é™å®šè‰²å€¼ï¼ˆå¤±çœŸï¼‰
                return Math.round(value/step)*step
              }

              function findColor(r,g,b){//é€šè¿‡è‰²æ¿ç®€åŒ–é¢œè‰²ï¼ˆä¿çœŸï¼‰
                var palette2 = [...palette,...colorBox];
                //console.log(palette2)
                var minDist = Infinity;
                var keyColor = null;
                
                if ( !palette2.includes([r,g,b])){
                  for ( var i = 0; i < palette2.length; i++){
                    //var dist = Math.abs(palette2[i][0] - r) + Math.abs(palette2[i][1] - g) + Math.abs(palette2[i][2] - b);
                    var dist = Math.sqrt(
                      Math.pow(palette2[i][0] - r,2) + Math.pow(palette2[i][1] - g,2) + Math.pow(palette2[i][2] - b,2)
                    )
                    if ( dist < minDist){
                      minDist = dist;
                      keyColor = [palette2[i][0],palette2[i][1],palette2[i][2]]
                    }
                  }
                } else {
                  keyColor = [r,g,b]
                }
                
                return keyColor
              }

              //*
              for (var i = 0; i < data.length; i += 4){
                var [r,g,b,a] = [data[i],data[i + 1],data[i + 2],data[i + 3]];
                var x = (i / 4) % img.width,y = Math.floor((i / 4) / img.width);//è·å–åƒç´ åæ ‡
                if(r !== g && r !== b && g !== b ){
                  data[i] = toStep(r,newStep);
                  data[i + 1] = toStep(g,newStep);
                  data[i + 2] = toStep(b,newStep);
                }
                if ( quality < 5){
                  if ( a < 10 || a > 245){
                    data[i + 3] = a;
                  } else {
                    var stepA = Math.ceil(2.5 * ((10 - quality)/10 + 1));
                    newA = Math.floor((a - 1) / stepA) * stepA + 1;
                    ea = newA - data[i + 3];
                    data[i + 3] = newA;

                    function floyd(dx,dy,factor){//è¯¯å·®æ‰©æ•£
                      if (x + dx >= 0 && x + dx < img.width && y + dy < img.height){
                        var newIndex = ((y + dy) * img.width + (x + dx)) * 4;//å½“å‰åƒç´ çš„å‘¨å›´åƒç´ 
                        data[newIndex + 3] += ea * factor;//æŠ–åŠ¨
                      }
                    }
                    //*
                    floyd(1,0,7/32)
                    floyd(-1,1,3/32)
                    floyd(0,1,4/32)
                    floyd(1,1,2/32)
                    floyd(2,0,6/32)
                    floyd(-2,2,2/32)
                    floyd(0,2,5/32)
                    floyd(2,2,3/32)//çŸ©é˜µ
                    //*/
                  }
                } else {
                  data[i + 3] = a;
                }
              }
              //*/

              if ( quality == 9){
                for (var i = 0; i < data.length; i += 4){
                  var [r,g,b,a] = [data[i],data[i + 1],data[i + 2],data[i + 3]];
                  var x = (i / 4) % img.width,y = Math.floor((i / 4) / img.width);//è·å–åƒç´ åæ ‡
                  if(r !== g && r !== b && g !== b ){
                    var cl = findColor(r,g,b);
                    var er = r - cl[0], eg = g - cl[1], eb = b - cl[2];
                    data[i] = cl[0];
                    data[i + 1] = cl[1];
                    data[i + 2] = cl[2];
                    function floyd(dx,dy,factor){//è¯¯å·®æ‰©æ•£
                      if (x + dx >= 0 && x + dx < img.width && y + dy < img.height){
                        var newIndex = ((y + dy) * img.width + (x + dx)) * 4;//å½“å‰åƒç´ çš„å‘¨å›´åƒç´ 
                        data[newIndex] += er * factor;
                        data[newIndex + 1] += eg * factor;
                        data[newIndex + 2] += eb * factor;//æŠ–åŠ¨
                      }
                    }
                    //*
                    floyd(1,0,7/32)
                    floyd(-1,1,3/32)
                    floyd(0,1,4/32)
                    floyd(1,1,2/32)
                    floyd(2,0,6/32)
                    floyd(-2,2,2/32)
                    floyd(0,2,5/32)
                    floyd(2,2,3/32)//çŸ©é˜µ
                    //*/
                    
                  }
                }

              }
              ctx.putImageData(imageData,0,0);
              canvas.toBlob(function(blob){
                resolve(blob)
              },'image/png')
            })

            resolve(colorcut)
          }
        }
        
      })
      //return new Blob([u8a], { type: 'image/png' });
    } else if ( type == 'webp') {
      return new Promise((resolve, reject) => {
        //var blob = new Blob([u8a], { type: 'image/png' });
        var url = URL.createObjectURL(blob);
        var img = new Image()
        img.src = url;

        img.onload = function(){
          var palette = colorThief.getPalette(img,20,1)
          //console.log(Math.pow(2,quality*10))
          var canvas = document.createElement('canvas');
          canvas.width = img.width;
          canvas.height = img.height;
          var ctx = canvas.getContext('2d')
          ctx.drawImage(img,0,0)
          canvas.toBlob(function(blob){
            resolve(blob)
          },'image/webp',(quality/10))
        }
      })
    }
  
}

// æ‰¹é‡å‹ç¼©
async function compressImages(imgExportData) {
  //console.log(999)
  var imageDataArray = imgExportData.map(item => item.u8a)
  var targetSize = imgExportData.map(item => item.s*1000)
  var type = imgExportData.map(item => item.fileName.split('.').pop())
  var colorBox = imgExportData.map(item => item.col)
  const compressedImages = [];
  for (let i = 0; i < imageDataArray.length; i++) {
    var quality = 10; // åˆå§‹å‹ç¼©è´¨é‡
    //console.log(111)
    var result = new Blob([imageDataArray[i]], { type: 'image/png' });//åˆå§‹åŒ–
    //console.log(222,result.size,[i],imageDataArray[i].length,targetSize[i])
    //if (targetSize[i] && imageDataArray[i].length > targetSize[i] ){//å·²åˆ é™¤è¯¥åˆ¤æ–­ï¼Œä¼šå¯¼è‡´épngæ ¼å¼ç¼–ç é”™è¯¯
    var newBlob = new Blob([imageDataArray[i]], { type: 'image/jpeg' });
      do {
        try {
          result = await compressImage(newBlob, quality,type[i],colorBox[i]);
          if (quality == 9){//å…ˆä¸Š256è‰²+æ‰©æ•£ç®—æ³•ï¼Œåé¢é å‡è‰²å‹ç¼©
            newBlob = result;
          }
          if (targetSize[i] && result.size > targetSize[i] && quality > 1) {
            if ( quality - 1 >= 0){
              console.log("å‹ç¼©è´¨é‡:" + quality )
              quality -= 1; // å¦‚æœè¶…è¿‡ç›®æ ‡å¤§å°ï¼Œå‡å°‘è´¨é‡å†æ¬¡å°è¯•
            } else {
              quality = 0;
            }
            
            //console.log(result.size/1000 + 'k')
          } else {
            if ( !targetSize[i] || result.size <= targetSize[i] ){
              //console.log(targetSize[i])
              document.getElementById('imgsize-' + i ).innerHTML =  Math.floor(result.size/1000) + "k /è´¨é‡:" + Math.ceil(quality) 
            } else {
              if (result.size){
                document.getElementById('imgsize-' + i ).innerHTML = '<span style="color:var(--liColor1)">' +  Math.floor(result.size/1000) + "k /å‹ç¼©å¤±è´¥</span>"
              } else {
                document.getElementById('imgsize-' + i ).innerHTML = '<span style="color:var(--liColor1)">' +  Math.floor(result.length/1000) + "k /å‹ç¼©å¤±è´¥</span>"
              }
              
            }
            //console.log(result)
            break;
          }
        } catch (error) {
          console.error('å‹ç¼©è¿‡ç¨‹ä¸­å‘ç”Ÿé”™è¯¯:', error);
          break;
        }
      } while (result.size > targetSize[i]);
    //}//å·²åˆ é™¤è¯¥åˆ¤æ–­ï¼Œä¼šå¯¼è‡´épngæ ¼å¼ç¼–ç é”™è¯¯
    

    compressedImages.push(result);
  }
  return compressedImages;
}

// åˆ›å»ºZIPæ–‡ä»¶å¹¶æä¾›ä¸‹è½½
function createZipAndDownload(compressedImages) {
  var MN = new Date()
  var M = String(MN.getMonth() + 1).padStart(2, '0');
  var N = String(MN.getDate()).padStart(2, '0');
  var HHMMSS = String(MN.getHours()).padStart(2, '0') + String(MN.getMinutes()).padStart(2, '0') + String(MN.getSeconds()).padStart(2, '0');
  var zip = new JSZip();

  var imgs = imgExportData;
  compressedImages.forEach((blob, index) => {
    var path = imgs[index].fileName.split('/');
    var name = path.pop();
    if (imgs[index].fileName.split('/').length == 2) {
      var folder = zip.folder(path[0]);
      folder.file(name,blob);
    } else if (imgs[index].fileName.split('/').length == 3) {
      var folder1 = zip.folder(path[0]);
      var folder2 = folder1.folder(path[1]);
      folder2.file(name,blob);
    } else {
      zip.file(name,blob);
    }
  });


  zip.generateAsync({ type: "blob" }).then(function (content) {
    saveAs(content, docInfo + '-' + M + N + '_' + HHMMSS + '.zip');
  });
}

//å¤§å›¾å¯¼å…¥è£å‰ª
function cutImg(file, name) {
  if (file instanceof File) {
    // å¤„ç†æ–‡ä»¶
    //console.log('è¿™æ˜¯ä¸€ä¸ªæ–‡ä»¶');
    var reader = new FileReader();
    reader.readAsArrayBuffer(file);
    reader.onload = function (e) {
      var data = new Uint8Array(e.target.result);
      var url = URL.createObjectURL(new Blob([data]));
      cutImgToCanvas(url)
    };
  } else if (typeof file === 'string') {
    // å¤„ç†å­—ç¬¦ä¸²
    //console.log(file)
    cutImgToCanvas(file)
    //console.log('è¿™æ˜¯ä¸€ä¸ªå­—ç¬¦ä¸²');
  } else {
    // å…¶ä»–ç±»å‹çš„å¤„ç†
    console.log('æœªçŸ¥ç±»å‹è¾“å…¥');
  }



  function cutImgToCanvas(url) {

    var canvas = document.createElement("canvas")
    var ctx = canvas.getContext("2d")

    var image = new Image();
    image.src = url;
    image.onload = function () {
      canvas.width = image.width;
      canvas.height = image.height;

      requestAnimationFrame(function draw() {
        // ç»˜åˆ¶å›¾ç‰‡
        ctx.drawImage(image, 0, 0);
        var cuts = creCutArea({ w: canvas.width, h: canvas.height, x: 0, y: 0, s: 1 },4096);
        // æ£€æŸ¥å›¾ç‰‡æ˜¯å¦å®Œå…¨ç»˜åˆ¶
        if (image.complete) {
          //console.log(cuts.length)
          var cutImgs = []
          for (var i = 0; i < cuts.length; i++) {
            var canvas2 = document.createElement("canvas");
            canvas2.width = cuts[i].w;
            canvas2.height = cuts[i].h;
            var ctx2 = canvas2.getContext("2d");
            //requestAnimationFrame(function draw() {
            ctx2.drawImage(canvas, cuts[i].x, cuts[i].y, cuts[i].w, cuts[i].h, 0, 0, cuts[i].w, cuts[i].h);
            var imgData = new Uint8Array(atob(canvas2.toDataURL('image/png').split(',')[1]).split('').map(function (c) { return c.charCodeAt(0); }));
            if (cuts.length > 1) {
              cutImgs.push({ img: imgData, w: canvas2.width, h: canvas2.height, name: name + "-" + (i + 1), x: cuts[i].x, y: cuts[i].y })
            } else {
              cutImgs.push({ img: imgData, w: canvas2.width, h: canvas2.height, name: name, x: cuts[i].x, y: cuts[i].y })
            }

            //});  
            if (i == cuts.length - 1) {
              //console.log(cutImgs)
              message([cutImgs, 'pixelIm'])
            }
          }

        }

      });
    }

  }

}

//svgæ‹†è§£
function processSVG(svgCode) {

  // åˆ›å»ºä¸€ä¸ªæ–°çš„DOMè§£æå™¨
  var parser = new DOMParser();
  // è§£æSVGä»£ç 
  var svgDoc = parser.parseFromString(svgCode, 'text/xml');
  var svgRoot = svgDoc.documentElement;
  //console.log(svgRoot)
  // ç»“æœæ•°ç»„
  var result = [];
  // å¼€å§‹éå†
  traverse(svgRoot);
  function traverse(node) {
    if (node.nodeType === Node.ELEMENT_NODE) {
      if (node.tagName.toLowerCase() === 'image') {
        // å¤„ç†imageèŠ‚ç‚¹
        var imgs = cutImg(node.getAttribute('xlink:href'), "å›¾ç‰‡")
      }
    }
    for (let i = 0; i < node.childNodes.length; i++) {
      traverse(node.childNodes[i]);
    }
  }
}

//è£åˆ‡æ–¹æ¡ˆ
function creCutArea(info,mix) {//{w:,h:,x:,y:,s:}
  var W = info.w, H = info.h;//å›¾ç‰‡å®½é«˜
  var Ws = info.w, Hs = info.h;//éå°¾éƒ¨éƒ¨åˆ†çš„è£å‰ªå®½é«˜
  var lastWs = info.w, lastHs = info.h;//å°¾éƒ¨çš„è£å‰ªå®½é«˜
  var X = info.x, Y = info.y;//è£åˆ‡åŒºåæ ‡
  var cutW = 1, cutH = 1;//çºµæ¨ªè£å‰ªæ•°é‡
  var cuts = [];//ä»å·¦åˆ°å³ï¼Œä»ä¸Šåˆ°å°çš„è£åˆ‡åŒºåŸŸé›†
  var tips;
  //åˆ‡å‰²æ–¹æ¡ˆ
  if (W * info.s <= mix && H * info.s <= mix) {//4Kä»¥å†…ï¼Œæ­£å¸¸ç”Ÿæˆ
    cuts = [{ w: W, h: H, x: info.x, y: info.y, s: 1 }]
    return cuts;
  } else {//å¤šè¡Œåˆ—å®«æ ¼
    cutW = Math.ceil((W * info.s) / mix)
    cutH = Math.ceil((H * info.s) / mix)
    if (W % cutW == 0) { //å®½åº¦åˆšå¥½ç­‰åˆ†
      Ws = W / cutW
      lastWs = Ws

    } else { //æœ‰å°æ•°ç‚¹
      Ws = Math.ceil(W / cutW) //å‘ä¸Šå–æ•´ï¼Œæœ€åä¸€æˆªçŸ­ä¸€äº›
      lastWs = W - (Ws * (cutW - 1))
    }
    if (H % cutH == 0) { //é•¿åº¦åˆšå¥½ç­‰åˆ†
      Hs = H / cutH
      lastHs = Hs
      tips = "é«˜è¢«æ•´é™¤"
    } else { //æœ‰å°æ•°ç‚¹
      Hs = Math.ceil(H / cutH) //å‘ä¸Šå–æ•´ï¼Œæœ€åä¸€æˆªçŸ­ä¸€äº›
      lastHs = H - (Hs * (cutH - 1))
      tips = "é«˜ä¸èƒ½æ•´é™¤ï¼Œå‰©ä½™ï¼š" + lastHs
    }

    // æ‹†åˆ†å›¾åƒæ•°æ®
    for (var i = 0; i < (cutW * cutH); i++) {

      if ((i + 1) % cutW == 0 && i !== (cutW * cutH) - 1 && i !== 0) {
        cuts.push({ w: lastWs, h: Hs, x: X, y: Y, });
        Y = Y + Hs;
        X = info.x;
      } else if (i == (cutW * cutH) - 1) {
        cuts.push({ w: lastWs, h: lastHs, x: X, y: Y, t: tips });
      } else {
        if (i > (cutW * (cutH - 1)) - 1) {
          cuts.push({ w: Ws, h: lastHs, x: X, y: Y });
        } else {
          cuts.push({ w: Ws, h: Hs, x: X, y: Y });
        }

        if (cutW == 1) {
          X = info.x;
          Y = Y + Hs;
        } else {
          X = X + Ws;
        }

      }

    }
    return cuts;
  }

}

</script>
</body>
</html>