<!DOCTYPE html>
<html data-theme="dark" data-language="En" data-plugin="widget">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0,user-scalable=no">
  <link rel="stylesheet" href="https://cdn.jsdelivr.net.cn/gh/YNYU01/YNYU_SET@de30e231ecca2aebcb5f047c510989598a99bc97/builds/yn_style.css"  >
  <script src="https://cdn.jsdelivr.net.cn/gh/YNYU01/YNYU_SET@de30e231ecca2aebcb5f047c510989598a99bc97/publics/run.js"></script>
  <style>
    :root{
      --mainFontSize:12px;
      --mainFontSize-mini:10px;
      --pointer:url('https://cdn.jsdelivr.net.cn/gh/YNYU01/YNYU_SET@ba19c5d927f0c9cc1bb1647b224fb58667102074/VI/pointer_24.png'),auto;
    }
    html{
      cursor: url('https://cdn.jsdelivr.net.cn/gh/YNYU01/YNYU_SET@ba19c5d927f0c9cc1bb1647b224fb58667102074/VI/cursor_16.png'),auto;
    }

    * {
      cursor: inherit;
    }

    input[type="text"],textarea{
      cursor: text;
    }
     
    #codeInput-scroll { 
      font-family: 'Roboto Mono', monospace; 
    }
    /*--按钮类*/
    [data-btn]{
      max-width: 580px;
      padding: 2px 0;
      border: 1px solid var(--boxBod);
      box-sizing: border-box;
      cursor: var(--pointer,pointer);
      position: relative;
    }

    [data-btn]:disabled{
      background: var(--boxGry);
      transform: translateY(1px);
      cursor: default;
      opacity: 0.6;
    }

    [data-btn]:hover{
      background: var(--boxGry);
    }

    [data-btn]:active{
      transform: translateY(1px);
    }

    [data-btn="op"]{
      border: none;
      background: none;
    }

    [data-btn="op"]:hover{
      background: none;
      opacity: 0.5;
    }

    [data-btn="main"]{
      border-radius: 20px;
      background: var(--boxGry);
    }

    [data-input-unit]{
      height: 20px;
      width: 18px;
      flex: 0 0 auto;
      padding: 0 0 0 0.5ch;
      background: var(--boxGry);
      margin-left: -0.5ch;
      border-radius: 0 4px 4px 0;
    }

    [data-input-unit="auto"]{
      width: fit-content;
      padding:0 0.5ch 0 1ch;
    }

    #codeType [data-option="option"]{
      padding-left: 10px;
    }

    #bottom{
      border-top: 1px solid var(--boxBod);
      background-image: url('https://cdn.jsdelivr.net.cn/gh/YNYU01/YNYU_SET@de30e231ecca2aebcb5f047c510989598a99bc97/VI/logo_graph_bod.png'), linear-gradient(rgba(20, 20, 20, 0.2), rgba(20, 20, 20, 0.2));
      background-size: 300px auto;
      background-repeat: repeat-x;
      background-position: 0 0;
      background-color: var(--boxBak);
      animation: bgMove 40s linear infinite;
    }
    @keyframes bgMove {
      0% {
        background-position-x: 0;
      }
      100% {
        background-position-x: -300px;
      }
    }

  </style>
</head>
<body>
  <div class="df-ffc" style="--boxBak: #171717; padding:12px 12px 6px 12px;">
    <div class="df-ffc gap8 pad10 bsb">
      <div class="df-sc gap4 w100">
        <div class="op6">Code Input:</div>
        <div id="codeType" class="df-lc pos-r gap4" data-select data-select-close data-select-value="AUTO" style="width: 90px; z-index:2;">
          <input id="select-value-1" type="text" data-select-input="textContent" readonly value="Auto">
          <input id="select-show-1" data-select-pick type="checkbox">
          <label for="select-show-1" class="show-next wh100 pos-a" style="top:0; right: 0;"></label>
          <div data-select-options class="df-ffc pos-a w100 noscrollbar" style="white-space: normal; display: none; top:24px;">
            <div class="pointer" data-option="option" data-option-main="true" data-option-value="AUTO">Auto</div>
            <div class="pointer" data-option="option" data-option-main="false" data-option-value="javascript">JavaScript</div>
            <div class="pointer" data-option="option" data-option-main="false" data-option-value="html">HTML</div>
            <div class="pointer" data-option="option" data-option-main="false" data-option-value="css">CSS</div>
            <div class="pointer" data-option="option" data-option-main="false" data-option-value="json">Json</div>
            <div class="pointer" data-option="option" data-option-main="false" data-option-value="sql">SQL</div>
            <div class="pointer" data-option="option" data-option-main="false" data-option-value="bash">Bash</div>
            <div class="pointer" data-option="option" data-option-main="false" data-option-value="php">PHP</div>
            <div class="pointer" data-option="option" data-option-main="false" data-option-value="python">Python</div>
            <div class="pointer" data-option="option" data-option-main="false" data-option-value="go">GO</div>
            <div class="pointer" data-option="option" data-option-main="false" data-option-value="rust">Rust</div>
            <div class="pointer" data-option="option" data-option-main="false" data-option-value="java">Java</div>
            <div class="pointer" data-option="option" data-option-main="false" data-option-value="c">C</div>
            <div class="pointer" data-option="option" data-option-main="false" data-option-value="csharp">C#</div>
            <div class="pointer" data-option="option" data-option-main="false" data-option-value="ruby">Ruby</div>
            <div class="pointer" data-option="option" data-option-main="false" data-option-value="typescript">TypeScript</div>
          </div>
        </div>
      </div>
      <div id="codeInput-scroll" class="w100 pos-r">
        <textarea data-textarea style="height: 260px;" class="w100" data-textarea-wrap="false" spellcheck="false" id="codeInput"
        ></textarea>
        <!--清空-->
        <div class="pos-a wh-12" data-close="clear"  style="right: 4px; top:4px;">
          <btn-close></btn-close>
        </div>
      </div>
    </div>
    <div class="df-lc w100 pad10 bsb mar-b10" style="gap: 20px;">
      <div class="df-lc gap4 fl1">
        <div class="wh-16 pos-r" data-tips="auto" 
        data-tips-y="top" data-tips-x="left" 
        data-tips-text-en="Set wap width"
        style="--tips-w: 8ch;">
          <svg width="100%" height="100%" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
            <path fill="var(--mainColor)" d="M20.4001 7.14238L19.2307 7.3287L16.8062 19.2H14.1886L11.8836 10.6293H11.8193L9.81159 19.2H7.20469L4.76945 7.3287L3.6001 7.14238V4.80005H8.8568V7.14238L7.62309 7.43517L8.71734 14.023H8.78171L10.8001 4.80005H12.9028L15.2399 14.0496H15.3043L16.3878 7.44848L15.1434 7.14238V4.80005H20.4001V7.14238Z"/>
            <rect fill="var(--mainColor)" y="3.6001" width="1.8" height="16.8"/>
            <rect fill="var(--mainColor)" x="22.2" y="3.6001" width="1.8" height="16.8"/>
          </svg>          
        </div>
        <div class="df-lc fl1" >
          <input type="text" id="widthInput" data-input data-input-type="float"  data-input-must="100,2000" placeholder="123" style=" text-align: center; height: 20px;">
          <div class="df-cc" data-input-unit="auto">px</div>
        </div>
      </div>
      <div class="df-lc gap4 fl1">
        <div class="wh-14 pos-r" data-tips="auto" 
        data-tips-y="top" data-tips-x="left" 
        data-tips-text-en="Set font size"
        style="--tips-w: 8ch;">
          <input-fontsize></input-fontsize>
        </div>
        <div class="df-lc fl1" >
          <input type="text" id="fontSizeInput" data-input data-input-type="float"  data-input-must="8,72" placeholder="16" style=" text-align: center; height: 20px;">
          <div class="df-cc" data-input-unit="auto">px</div>
        </div>
      </div>
    </div>
    <div data-btn="main" id="applyBtn" class="df-cc bod-r8">Apply</div>
  </div>

  <div id="bottom" class="df-sc pad10 bsb">
    <div style="height: 18px; --fill: var(--mainColor);">
      <set-en-home></set-en-home>
    </div>
    <div class="font-s10 op6">©2024-2025 @YNYU www.ynyuset.cn</div>
  </div>

  <script src="https://cdn.jsdelivr.net.cn/gh/YNYU01/YNYU_SET@de30e231ecca2aebcb5f047c510989598a99bc97/builds/yn_icon.js"></script>
  <script src="https://cdn.jsdelivr.net.cn/gh/YNYU01/YNYU_SET@de30e231ecca2aebcb5f047c510989598a99bc97/builds/yn_comp.js"></script>
  <script src="https://cdn.jsdelivr.net.cn/gh/YNYU01/YNYU_SET@de30e231ecca2aebcb5f047c510989598a99bc97/builds/yn_tool.js"></script>
  <script src="https://cdn.jsdelivr.net.cn/gh/YNYU01/YNYU_SET@de30e231ecca2aebcb5f047c510989598a99bc97/publics/graph.js"></script>
  <script src="https://cdn.jsdelivr.net.cn/gh/YNYU01/YNYU_SET@de30e231ecca2aebcb5f047c510989598a99bc97/publics/other/prism.js"></script>
  <!-- Prism.js 语言支持（注意加载顺序：基础语言和依赖组件先加载） -->
  <!-- PHP 需要 markup-templating 依赖 -->
  <script src="https://cdn.jsdelivr.net.cn/npm/prismjs@1.23.0/components/prism-markup-templating.min.js"></script>
  <!-- 基础语言 -->
  <script src="https://cdn.jsdelivr.net.cn/npm/prismjs@1.23.0/components/prism-json.min.js"></script>
  <script src="https://cdn.jsdelivr.net.cn/npm/prismjs@1.23.0/components/prism-sql.min.js"></script>
  <script src="https://cdn.jsdelivr.net.cn/npm/prismjs@1.23.0/components/prism-bash.min.js"></script>
  <script src="https://cdn.jsdelivr.net.cn/npm/prismjs@1.23.0/components/prism-php.min.js"></script>
  <script src="https://cdn.jsdelivr.net.cn/npm/prismjs@1.23.0/components/prism-python.min.js"></script>
  <script src="https://cdn.jsdelivr.net.cn/npm/prismjs@1.23.0/components/prism-go.min.js"></script>
  <script src="https://cdn.jsdelivr.net.cn/npm/prismjs@1.23.0/components/prism-rust.min.js"></script>
  <script src="https://cdn.jsdelivr.net.cn/npm/prismjs@1.23.0/components/prism-java.min.js"></script>
  <script src="https://cdn.jsdelivr.net.cn/npm/prismjs@1.23.0/components/prism-c.min.js"></script>
  <script src="https://cdn.jsdelivr.net.cn/npm/prismjs@1.23.0/components/prism-csharp.min.js"></script>
  <script src="https://cdn.jsdelivr.net.cn/npm/prismjs@1.23.0/components/prism-ruby.min.js"></script>
  <!-- TypeScript 依赖 JavaScript，确保 JavaScript 已加载后再加载 TypeScript -->
  <script src="https://cdn.jsdelivr.net.cn/npm/prismjs@1.23.0/components/prism-typescript.min.js"></script>

  <script>
    window.onmessage = (event) => {
      const { type, data } = event.data.pluginMessage || {};
      if (type === 'init') {
        document.getElementById('codeInput').value = data.textContent || '';
        if (data.fontSize) {
          document.getElementById('fontSizeInput').value = data.fontSize;
        }
        if (data.width) {
          document.getElementById('widthInput').value = data.width;
        }
      }
    };
 
    getElementMix('codeInput').addEventListener('change',()=>{
      document.querySelector('[data-option-value="AUTO"]').click();
    });
    let codeColor = {
      mainColor: "#acacac",
      code1:"#48a67b",
      code2:"#9377b6",
      code3:"#48a64d",
      code4:"#b677b1",
      code5:"#a66e48",
      code6:"#77b6b6",
      code7:"#a64848",
      code8:"#527ac4",
      code9:"#e09524",
      code10:"#ec657c",
    }

    // 代码类型检测函数
    function detectLanguage(code) {
      if (!code || !code.trim()) return 'javascript';
      
      const trimmed = code.trim();
      
      // HTML/XML 检测（优先检测，因为可能包含其他代码）
      if (/^<\s*!?DOCTYPE\s+html/i.test(trimmed) || 
          /^<\s*html/i.test(trimmed) || 
          (/^<\s*[\w-]+[\s>]/.test(trimmed) && /<\s*\/[\w-]+[\s>]/.test(code))) {
        return 'html';
      }
      
      // CSS 检测（优先检测，因为CSS特征明显）
      // 1. 检测CSS变量（最明显的CSS特征）
      if (/--[\w-]+\s*:/.test(code)) {
        return 'css';
      }
      // 2. 检测CSS at-rules
      if (/@(media|import|keyframes|font-face|charset|namespace|page|supports|document|viewport)\s/.test(code)) {
        return 'css';
      }
      // 3. 检测CSS选择器后跟大括号（包括属性选择器、伪类等）
      // 匹配：html[...]{, .class{, #id{, [attr]{, :hover{, @media{ 等
      if (/^\s*([#.][\w-]+|[\w-]+(\[[^\]]*\])*|[\w-]*\[[^\]]+\]|[\w-]+:[\w-]+|@[\w-]+|[\w-]+\s*[>+~]\s*[\w-]+|:[\w-]+(\([^)]*\))?)\s*\{/.test(trimmed)) {
        // 排除JavaScript对象字面量
        if (!/function\s*\(|=>\s*\{|const\s+\w+\s*=\s*\{|let\s+\w+\s*=\s*\{/.test(code)) {
          return 'css';
        }
      }
      // 4. 检测CSS属性格式（property: value;）且没有JS特征
      if (/^\s*[\w-]+\s*:\s*[^;]+;/.test(trimmed) && 
          !/function|const\s+\w+\s*=|let\s+\w+\s*=|var\s+\w+\s*=|=>/.test(code) &&
          /[\w-]+\s*:\s*[^;]+;/.test(code)) {
        return 'css';
      }
      
      // JSON 检测（在JS之前，避免误判）
      if (/^\s*[\{\[]/.test(trimmed) && /[\}\]]\s*$/.test(trimmed) &&
          /"[^"]*"\s*:/.test(code) && !/function|=>|const|let|var/.test(code)) {
        return 'json';
      }
      
      // SQL 检测
      if (/^\s*(SELECT|INSERT|UPDATE|DELETE|CREATE|ALTER|DROP)\s+/i.test(trimmed) ||
          /FROM\s+\w+|WHERE\s+\w+\s*=|JOIN\s+\w+/i.test(code)) {
        return 'sql';
      }
      
      // Shell/Bash 检测
      if (/^\s*#!\/bin\/(bash|sh)/.test(trimmed) ||
          /^\s*\$\(/.test(trimmed) || /if\s+\[/.test(code)) {
        return 'bash';
      }
      
      // PHP 检测
      if (/^\s*<\?php/.test(trimmed) || /<\?=/.test(code)) {
        return 'php';
      }
      
      // Python 检测（在JS之前，因为Python也有import/class）
      if (/^\s*(def|from\s+\w+\s+import|if\s+__name__|print\()/.test(trimmed) ||
          (/:\s*$/.test(trimmed) && /^\s*(if|elif|else|for|while|def|class|try|except|finally)\s+/.test(trimmed)) ||
          /^\s*import\s+\w+/.test(trimmed) && !/from\s+['"]/.test(code) && !/require\(/.test(code)) {
        return 'python';
      }
      
      // Go 检测（在JS之前，因为Go也有package/import）
      if (/^\s*package\s+\w+/.test(trimmed) ||
          /func\s+\w+\s*\(/.test(code) ||
          (/:\s*=/.test(code) && /import\s*\(/.test(code))) {
        return 'go';
      }
      
      // Rust 检测（在JS之前）
      if (/^\s*(fn|let\s+mut|pub\s+(fn|mod|use)|use\s+\w+::)/.test(trimmed) ||
          /!\s*\{/.test(code) || (/::/.test(code) && /fn\s+\w+/.test(code))) {
        return 'rust';
      }
      
      // Java 检测（在JS之前，因为Java也有class）
      if (/^\s*(public|private|protected)\s+(static\s+)?(class|interface|enum)/.test(trimmed) ||
          /^\s*package\s+[\w.]+;/.test(trimmed) ||
          /System\.(out|err)\.print/.test(code)) {
        return 'java';
      }
      
      // C/C++ 检测
      if (/^\s*#\s*include\s*[<"]/.test(trimmed) ||
          /^\s*(int|void|char|float|double)\s+main\s*\(/.test(trimmed) ||
          /std::(cout|cin|endl)/.test(code)) {
        if (/std::|namespace\s+std|using\s+namespace/.test(code)) {
          return 'cpp';
        }
        return 'c';
      }
      
      // C# 检测
      if (/^\s*using\s+System;/.test(trimmed) ||
          (/^\s*(public|private|protected)\s+class/.test(trimmed) && /namespace\s+\w+/.test(code))) {
        return 'csharp';
      }
      
      // Ruby 检测
      if (/^\s*(def\s+\w+\s*\(|class\s+\w+|module\s+\w+|require\s+['"]|puts\s+)/.test(trimmed) ||
          /\.each\s*\{|\.map\s*\{/.test(code)) {
        return 'ruby';
      }
      
      // TypeScript 检测（在JS之前，因为TS包含JS特征）
      if (/:\s*(string|number|boolean|any|void|object|Array<|Promise<|Record<)/.test(code) ||
          /interface\s+\w+|type\s+\w+\s*=|as\s+\w+/.test(code) ||
          (/^\s*(import|export|const|let|var|function|class)\s+/.test(trimmed) && 
           /:\s*(string|number|boolean|any|void|object|Array<|Promise<)/.test(code))) {
        return 'typescript';
      }
      
      // JavaScript 检测（更严格的条件）
      if (/=>\s*\{?/.test(code) || // 箭头函数
          /console\.(log|error|warn|info|debug)/.test(code) || // console方法
          /require\s*\(|module\.exports|exports\./.test(code) || // Node.js特征
          /^\s*(const|let|var)\s+\w+\s*=/.test(trimmed) || // 变量声明
          /^\s*function\s+\w+\s*\(/.test(trimmed) || // 函数声明
          /^\s*class\s+\w+/.test(trimmed) && /constructor\s*\(/.test(code) || // ES6类
          (/^\s*(import|export)\s+/.test(trimmed) && /from\s+['"]/.test(code))) { // ES6模块
        return 'javascript';
      }
      
      // 默认返回 javascript
      return 'javascript';
    }

    const themeColors = {
      'keyword': '#C586C0',        // 关键字（紫色）
      'string': '#CE9178',         // 字符串（橙色）
      'number': '#B5CEA8',         // 数字（浅绿色）
      'function': '#DCDCAA',       // 函数（黄色）
      'class-name': '#4EC9B0',     // 类名（青色）
      'variable': '#9CDCFE',       // 变量（浅蓝色）
      'comment': '#6A9955',        // 注释（绿色）
      'property': '#9CDCFE',       // 属性（浅蓝色）
      'punctuation': '#D4D4D4',    // 标点（白色）
      'operator': '#D4D4D4',       // 运算符（白色）
      'bracket': '#D4D4D4',        // 括号（白色）
      'tag': '#569CD6',            // HTML 标签（蓝色）
      'attr-name': '#92C5F7',      // 属性名（浅蓝色）
      'attr-value': '#CE9178',     // 属性值（橙色）
      'directive': '#C586C0',      // 指令（紫色）
      'entity': '#CE9178',         // 实体（橙色）
      'url': '#CE9178',            // URL（橙色）
      'symbol': '#DCDCAA',         // 符号（黄色）
      'regex': '#CE9178',          // 正则（橙色）
      'boolean': '#569CD6',        // 布尔值（蓝色）
      'template-string': '#CE9178',// 模板字符串（橙色）
      'interpolation': '#9CDCFE',  // 插值（浅蓝色）
      'parameter': '#9CDCFE',      // 参数（浅蓝色）
      'constant': '#4FC1FF',       // 常量（亮蓝色）
    };

    function sendData() {
      const codeContent = document.getElementById('codeInput').value;
      
      let detectedLang = document.getElementById('codeType').getAttribute('data-select-value');
      // 去除前后空格，避免空格导致的判断失败
      if(detectedLang && detectedLang.trim() == 'AUTO'){
        // 自动检测代码类型
        detectedLang = detectLanguage(codeContent);
        if(detectedLang){
          let option = document.getElementById('codeType').querySelector(`[data-option-value="${detectedLang}"]`);
          if(option){
            option.click();
          }
        }
      } else {
        // 去除空格，确保语言标识符正确
        detectedLang = detectedLang ? detectedLang.trim() : 'javascript';
      }
      
      // 获取对应的 Prism 语言对象，如果不支持则降级到 javascript
      let prismLang = Prism.languages[detectedLang];
      let finalLang = detectedLang;
      
      if (!prismLang) {
        console.warn(`Prism.js doesn't support language: ${detectedLang}, falling back to javascript`);
        prismLang = Prism.languages.javascript;
        finalLang = 'javascript';
      }
      
      // 使用检测到的语言进行高亮
      let codePrism = null;
      try {
        // 检查语言定义是否完整（某些语言可能加载失败）
        if (prismLang && typeof prismLang === 'object') {
          codePrism = Prism.highlight(codeContent, prismLang, finalLang);
        } else {
          throw new Error(`Language definition for ${finalLang} is invalid`);
        }
      } catch (e) {
        console.error('Error highlighting code:', e);
        console.warn(`Falling back to javascript for language: ${finalLang}`);
        // 降级到 javascript
        try {
          if (Prism.languages.javascript) {
            codePrism = Prism.highlight(codeContent, Prism.languages.javascript, 'javascript');
          } else {
            codePrism = codeContent; // 如果连 javascript 都没有，使用原始代码
          }
        } catch (e2) {
          console.error('Error highlighting with javascript fallback:', e2);
          codePrism = codeContent; // 如果高亮失败，使用原始代码
        }
      }
      
      // 将 Prism 高亮后的 HTML 转换为数组格式
      // 格式: [{tagname:'span',color:'#xxxxxx',text:'...'},...]
      function convertPrismToSpanArray(html) {
        if (!html || typeof html !== 'string') return [];
        
        // 颜色转换辅助函数：将各种颜色格式转换为hex
        function colorToHex(colorStr) {
          if (!colorStr) return null;
          
          const lowerColor = colorStr.toLowerCase().trim();
          
          // HEX格式: #rgb, #rrggbb, #rrggbbaa
          if (lowerColor.startsWith('#')) {
            const hex = lowerColor.replace(/[^0-9a-f]/g, '');
            if (hex.length === 3 || hex.length === 6 || hex.length === 8) {
              // 3位hex扩展为6位
              if (hex.length === 3) {
                return '#' + hex.split('').map(c => c + c).join('');
              }
              // 6位或8位hex，只取前6位（忽略alpha通道）
              return '#' + hex.substring(0, 6);
            }
          }
          
          // RGB格式: rgb(r, g, b) 或 rgba(r, g, b, a)
          const rgbMatch = lowerColor.match(/rgba?\(([^)]+)\)/);
          if (rgbMatch) {
            const values = rgbMatch[1].split(',').map(v => parseFloat(v.trim()));
            if (values.length >= 3) {
              const r = Math.max(0, Math.min(255, Math.round(values[0])));
              const g = Math.max(0, Math.min(255, Math.round(values[1])));
              const b = Math.max(0, Math.min(255, Math.round(values[2])));
              // 使用yn_comp.js中的rgbTohex函数
              if (typeof rgbTohex === 'function') {
                return rgbTohex(r, g, b);
              }
              // 备用实现
              return '#' + [r, g, b].map(x => {
                const hex = x.toString(16);
                return hex.length === 1 ? '0' + hex : hex;
              }).join('');
            }
          }
          
          // HSL格式: hsl(h, s%, l%) 或 hsla(h, s%, l%, a)
          const hslMatch = lowerColor.match(/hsla?\(([^)]+)\)/);
          if (hslMatch) {
            const values = hslMatch[1].split(',').map(v => parseFloat(v.replace('%', '').trim()));
            if (values.length >= 3) {
              const h = values[0];
              const s = Math.max(0, Math.min(100, values[1]));
              const l = Math.max(0, Math.min(100, values[2]));
              // 使用yn_comp.js中的hslTorgb和rgbTohex函数
              if (typeof hslTorgb === 'function' && typeof rgbTohex === 'function') {
                const rgb = hslTorgb(h, s, l, 255);
                return rgbTohex(rgb[0], rgb[1], rgb[2]);
              }
              // 备用实现（简化版HSL转RGB）
              const hNorm = (h % 360) / 360;
              const sNorm = s / 100;
              const lNorm = l / 100;
              let r, g, b;
              if (sNorm === 0) {
                r = g = b = lNorm;
              } else {
                const hue2rgb = (p, q, t) => {
                  if (t < 0) t += 1;
                  if (t > 1) t -= 1;
                  if (t < 1/6) return p + (q - p) * 6 * t;
                  if (t < 1/2) return q;
                  if (t < 2/3) return p + (q - p) * (2/3 - t) * 6;
                  return p;
                };
                const q = lNorm < 0.5 ? lNorm * (1 + sNorm) : lNorm + sNorm - lNorm * sNorm;
                const p = 2 * lNorm - q;
                r = hue2rgb(p, q, hNorm + 1/3);
                g = hue2rgb(p, q, hNorm);
                b = hue2rgb(p, q, hNorm - 1/3);
              }
              const rHex = Math.round(r * 255).toString(16).padStart(2, '0');
              const gHex = Math.round(g * 255).toString(16).padStart(2, '0');
              const bHex = Math.round(b * 255).toString(16).padStart(2, '0');
              return '#' + rHex + gHex + bHex;
            }
          }
          
          return null;
        }
        
        // 在文本中查找颜色代码并插入颜色方块
        function insertColorSquares(text) {
          if (!text) return text;
          
          // 匹配颜色代码的正则表达式
          // HEX: #rgb, #rrggbb, #rrggbbaa (后面不能跟hex字符)
          const hexPattern = /#([0-9a-fA-F]{3}|[0-9a-fA-F]{6}|[0-9a-fA-F]{8})(?![0-9a-fA-F])/g;
          // RGB/RGBA: rgb(r,g,b) 或 rgba(r,g,b,a)
          const rgbPattern = /rgba?\(\s*\d+(?:\.\d+)?\s*,\s*\d+(?:\.\d+)?\s*,\s*\d+(?:\.\d+)?(?:\s*,\s*[\d.]+)?\s*\)/g;
          // HSL/HSLA: hsl(h,s%,l%) 或 hsla(h,s%,l%,a)
          const hslPattern = /hsla?\(\s*\d+(?:\.\d+)?\s*,\s*\d+(?:\.\d+)?%\s*,\s*\d+(?:\.\d+)?%(?:\s*,\s*[\d.]+)?\s*\)/g;
          
          let result = text;
          const matches = [];
          
          // 收集所有颜色匹配（包括位置信息）
          [hexPattern, rgbPattern, hslPattern].forEach(pattern => {
            let match;
            pattern.lastIndex = 0; // 重置正则
            while ((match = pattern.exec(text)) !== null) {
              matches.push({
                index: match.index,
                length: match[0].length,
                color: match[0]
              });
            }
          });
          
          // 去重：如果同一个位置有多个匹配，只保留第一个
          const uniqueMatches = [];
          const seenIndices = new Set();
          matches.forEach(match => {
            if (!seenIndices.has(match.index)) {
              seenIndices.add(match.index);
              uniqueMatches.push(match);
            }
          });
          
          // 按位置倒序排序，从后往前替换，避免索引偏移
          uniqueMatches.sort((a, b) => b.index - a.index);
          
          // 从后往前插入颜色方块
          uniqueMatches.forEach(match => {
            const hexColor = colorToHex(match.color);
            if (hexColor) {
              const before = result.substring(0, match.index);
              const after = result.substring(match.index);
              result = before + `<Span fill="${hexColor}">■</Span>` + after;
            }
          });
          
          return result;
        }
        
        // 使用 DOM 解析器处理嵌套结构
        const tempDiv = document.createElement('div');
        tempDiv.innerHTML = html;
        
        // 递归处理节点，返回数组格式
        function processNode(node) {
          if (node.nodeType === Node.TEXT_NODE) {
            // 文本节点，处理颜色代码
            let text = node.textContent;
            const result = [];
            let lastIndex = 0;
            
            // 匹配颜色代码的正则表达式
            const hexPattern = /#([0-9a-fA-F]{3}|[0-9a-fA-F]{6}|[0-9a-fA-F]{8})(?![0-9a-fA-F])/g;
            const rgbPattern = /rgba?\(\s*\d+(?:\.\d+)?\s*,\s*\d+(?:\.\d+)?\s*,\s*\d+(?:\.\d+)?(?:\s*,\s*[\d.]+)?\s*\)/g;
            const hslPattern = /hsla?\(\s*\d+(?:\.\d+)?\s*,\s*\d+(?:\.\d+)?%\s*,\s*\d+(?:\.\d+)?%(?:\s*,\s*[\d.]+)?\s*\)/g;
            
            const matches = [];
            [hexPattern, rgbPattern, hslPattern].forEach(pattern => {
              let match;
              pattern.lastIndex = 0;
              while ((match = pattern.exec(text)) !== null) {
                matches.push({
                  index: match.index,
                  length: match[0].length,
                  color: match[0]
                });
              }
            });
            
            // 去重并按位置排序
            const uniqueMatches = [];
            const seenIndices = new Set();
            matches.forEach(match => {
              if (!seenIndices.has(match.index)) {
                seenIndices.add(match.index);
                uniqueMatches.push(match);
              }
            });
            uniqueMatches.sort((a, b) => a.index - b.index);
            
            // 处理文本和颜色代码
            uniqueMatches.forEach(match => {
              // 添加颜色代码之前的文本
              if (match.index > lastIndex) {
                const beforeText = text.substring(lastIndex, match.index);
                if (beforeText) {
                  result.push({ tagname: null, color: null, text: beforeText });
                }
              }
              // 添加颜色方块和原始颜色代码文本
              const hexColor = colorToHex(match.color);
              if (hexColor) {
                // 先添加颜色方块（使用颜色代码本身的颜色）
                result.push({ tagname: 'span', color: hexColor, text: '■' });
                // 再添加原始颜色代码文本（保持代码高亮的颜色，不应用颜色代码本身的颜色）
                result.push({ tagname: null, color: null, text: match.color });
              } else {
                // 如果无法转换颜色，至少保留原始文本
                result.push({ tagname: null, color: null, text: match.color });
              }
              lastIndex = match.index + match.length;
            });
            
            // 添加剩余的文本
            if (lastIndex < text.length) {
              const remainingText = text.substring(lastIndex);
              if (remainingText) {
                result.push({ tagname: null, color: null, text: remainingText });
              }
            }
            
            // 如果没有颜色代码，直接返回文本
            if (result.length === 0 && text) {
              return [{ tagname: null, color: null, text: text }];
            }
            
            return result.length > 0 ? result : [];
          } else if (node.nodeType === Node.ELEMENT_NODE) {
            const tagName = node.tagName.toLowerCase();
            
            if (tagName === 'span' && node.classList.contains('token')) {
              // 获取 token 类名
              const classes = Array.from(node.classList).filter(c => c !== 'token');
              let color = codeColor.mainColor; // 默认颜色
              
              // 查找匹配的类名
              for (const cls of classes) {
                if (themeColors[cls]) {
                  color = themeColors[cls];
                  break;
                }
              }
              
              // 如果没有找到匹配的，尝试匹配部分类名
              if (color === codeColor.mainColor) {
                for (const [key, value] of Object.entries(themeColors)) {
                  if (classes.some(c => c.includes(key) || key.includes(c))) {
                    color = value;
                    break;
                  }
                }
              }
              
              // 处理子节点，收集所有数组项
              const childArrays = [];
              Array.from(node.childNodes).forEach(child => {
                const childResult = processNode(child);
                if (Array.isArray(childResult) && childResult.length > 0) {
                  childArrays.push(...childResult);
                }
              });
              
              // 将子节点数组合并，如果有多个项，需要将它们组合
              if (childArrays.length === 0) {
                return [];
              } else {
                // 处理子节点数组：颜色方块保留，其他文本用 token 颜色包装
                const result = [];
                let currentText = '';
                
                childArrays.forEach(item => {
                  if (item.tagname === 'span' && item.text === '■') {
                    // 颜色方块，先保存之前的文本（如果有）
                    if (currentText) {
                      result.push({ tagname: 'span', color: color, text: currentText });
                      currentText = '';
                    }
                    // 添加颜色方块（保留原有颜色）
                    result.push(item);
                  } else if (item.tagname === 'span' && item.color) {
                    // 已经有颜色的 span，先保存之前的文本（如果有）
                    if (currentText) {
                      result.push({ tagname: 'span', color: color, text: currentText });
                      currentText = '';
                    }
                    // 保留原有的 span（可能是嵌套的）
                    result.push(item);
                  } else {
                    // 普通文本，累积
                    currentText += item.text || '';
                  }
                });
                
                // 添加剩余的文本
                if (currentText) {
                  result.push({ tagname: 'span', color: color, text: currentText });
                }
                
                return result;
              }
            } else {
              // 非 token span，递归处理子节点
              const result = [];
              Array.from(node.childNodes).forEach(child => {
                const childResult = processNode(child);
                if (Array.isArray(childResult) && childResult.length > 0) {
                  result.push(...childResult);
                }
              });
              return result;
            }
          }
          return [];
        }
        
        // 先完整处理整个 HTML 结构，提取所有的 spans（这样可以保持跨行的注释块等结构完整）
        const allSpans = [];
        Array.from(tempDiv.childNodes).forEach(child => {
          const childResult = processNode(child);
          if (Array.isArray(childResult) && childResult.length > 0) {
            allSpans.push(...childResult);
          }
        });
        
        // 将 spans 按换行符分割成行
        // 遍历所有 spans，根据文本中的换行符来分割
        const result = [];
        let currentLineSpans = [];
        let currentLineText = '';
        let lastIndent = 0;
        let lineIndex = 0;
        
        function finalizeLine() {
          if (currentLineSpans.length === 0 && currentLineText.trim() === '') {
            // 空行
            result.push({
              line: lineIndex++,
              indent: lastIndent,
              spans: [{ tagname: null, color: null, text: '' }]
            });
          } else {
            // 计算该行的缩进
            const leadingSpaces = (currentLineText.match(/^(\s*)/)?.[1] || '').length;
            const isEmptyLine = currentLineText.trim() === '';
            const indent = isEmptyLine ? lastIndent : Math.floor(leadingSpaces / 2);
            
            // 如果该行没有 spans，至少添加一个空文本项
            if (currentLineSpans.length === 0) {
              currentLineSpans.push({ tagname: null, color: null, text: '' });
            }
            
            result.push({
              line: lineIndex++,
              indent: indent,
              spans: currentLineSpans
            });
            
            // 仅在非空行时更新上一次的缩进
            if (!isEmptyLine) {
              lastIndent = indent;
            }
          }
          
          // 重置当前行
          currentLineSpans = [];
          currentLineText = '';
        }
        
        // 遍历所有 spans，按换行符分割
        allSpans.forEach(span => {
          const text = span.text || '';
          
          if (text.includes('\n')) {
            // 如果文本包含换行符，需要分割
            const parts = text.split('\n');
            
            for (let i = 0; i < parts.length; i++) {
              const part = parts[i];
              
              if (i === 0) {
                // 第一部分，添加到当前行
                if (part) {
                  currentLineSpans.push({
                    tagname: span.tagname,
                    color: span.color,
                    text: part
                  });
                  currentLineText += part;
                }
              } else {
                // 后续部分，先完成当前行，然后开始新行
                finalizeLine();
                
                if (part) {
                  currentLineSpans.push({
                    tagname: span.tagname,
                    color: span.color,
                    text: part
                  });
                  currentLineText += part;
                }
              }
            }
          } else {
            // 没有换行符，直接添加到当前行
            currentLineSpans.push({
              tagname: span.tagname,
              color: span.color,
              text: text
            });
            currentLineText += text;
          }
        });
        
        // 处理最后一行
        if (currentLineSpans.length > 0 || currentLineText) {
          finalizeLine();
        }
        
        return result;
      }
      
      // 转换高亮后的代码为数组格式（用于渲染）
      let spanContentArray = [];
      if (codePrism && typeof codePrism === 'string') {
        spanContentArray = convertPrismToSpanArray(codePrism);
      }
      
      const width = document.getElementById('widthInput').value * 1 || 400;
      const fontSize = document.getElementById('fontSizeInput').value * 1 || 16;
      
      //默认缩进以2为单位，判断缩进规律是不是4的倍数
      let indentRule = 2;
      let indents = spanContentArray.map(item => item.indent);
      if(indents.every(indent => indent % 4 !== 0)) {
        indentRule = 4;
      }
      // 发送数据：textContent 存储纯文本，spanContentArray 存储数组格式（用于渲染）
      parent.postMessage({ 
        pluginMessage: { 
          type: 'update', 
          data: { 
            textContent: codeContent,  // 纯文本
            spanContentArray: spanContentArray,  // 数组格式 [{tagname, color, text}, ...]
            width,
            fontSize,
            indentRule
          } 
        } 
      }, '*');
    }
    document.getElementById('applyBtn').addEventListener('click', sendData);
  
  </script>
</body>
</html>
